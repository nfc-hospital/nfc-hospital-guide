================================================================================
ê¸°ëŠ¥ë³„ ìƒì„¸ ë¶„ì„ ë³´ê³ ì„œ #5: WebSocket ì‹¤ì‹œê°„ í†µì‹ 
================================================================================
ì‘ì„±ì¼: 2025ë…„ 1ì›” 9ì¼
ë¶„ì„ ë²”ìœ„: ë°±ì—”ë“œ + í”„ë¡ íŠ¸ì—”ë“œ í†µí•©
í˜„ì¬ ì™„ì„±ë„: 60%
================================================================================

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸ“ ê´€ë ¨ íŒŒì¼ êµ¬ì¡°
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

ã€ë°±ì—”ë“œã€‘
backend/nfc_hospital_system/
â”œâ”€â”€ nfc_hospital_system/
â”‚   â”œâ”€â”€ asgi.py                 # ASGI ì• í”Œë¦¬ì¼€ì´ì…˜ ì„¤ì •
â”‚   â”œâ”€â”€ routing.py               # WebSocket URL ë¼ìš°íŒ…
â”‚   â””â”€â”€ middleware/
â”‚       â””â”€â”€ websocket_auth.py   # WebSocket ì¸ì¦ ë¯¸ë“¤ì›¨ì–´
â”œâ”€â”€ p_queue/
â”‚   â””â”€â”€ consumers.py            # ëŒ€ê¸°ì—´ WebSocket ì»¨ìŠˆë¨¸
â””â”€â”€ admin_dashboard/
    â””â”€â”€ consumers.py            # ê´€ë¦¬ì ëŒ€ì‹œë³´ë“œ ì»¨ìŠˆë¨¸

ã€í”„ë¡ íŠ¸ì—”ë“œã€‘
frontend-pwa/src/
â”œâ”€â”€ services/
â”‚   â””â”€â”€ websocketService.js     # WebSocket ì„œë¹„ìŠ¤ í´ë˜ìŠ¤
â”œâ”€â”€ hooks/
â”‚   â”œâ”€â”€ useWebSocket.js         # WebSocket React Hook
â”‚   â””â”€â”€ usePatientJourney.js    # í™˜ì ì—¬ì • WebSocket Hook
â””â”€â”€ components/
    â””â”€â”€ WebSocketTest.jsx       # WebSocket í…ŒìŠ¤íŠ¸ ì»´í¬ë„ŒíŠ¸

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸ” í˜„ì¬ êµ¬í˜„ ìƒíƒœ ë¶„ì„
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

================================================================================
1. ë°±ì—”ë“œ WebSocket ì‹œìŠ¤í…œ
================================================================================

ã€âœ… ì˜ êµ¬í˜„ëœ ë¶€ë¶„ã€‘

1.1 Django Channels ì„¤ì •
```python
# asgi.py
application = ProtocolTypeRouter({
    "http": django_asgi_app,
    "websocket": AuthMiddlewareStack(
        URLRouter(websocket_urlpatterns)
    ),
})

# routing.py
websocket_urlpatterns = [
    re_path(r'^ws/queue/(?P<queue_id>[\w-]+)/?$', QueueConsumer.as_asgi()),
    re_path(r'^ws/admin/dashboard/?$', DashboardConsumer.as_asgi()),
]
```
- Django Channels ê¸°ë³¸ ì„¤ì • ì™„ë£Œ âœ“
- HTTP/WebSocket í”„ë¡œí† ì½œ ë¶„ë¦¬ âœ“
- URL ê¸°ë°˜ ë¼ìš°íŒ… âœ“

1.2 Queue Consumer êµ¬í˜„
```python
class QueueConsumer(AsyncJsonWebsocketConsumer):
    async def connect(self):
        self.queue_id = self.scope['url_route']['kwargs'].get('queue_id')
        self.room_group_name = f'queue_{self.queue_id}'
        
        await self.channel_layer.group_add(
            self.room_group_name,
            self.channel_name
        )
        await self.accept()
        
    async def receive_json(self, content):
        message_type = content.get('type')
        
        if message_type == 'ping':
            await self.send_json({'type': 'pong'})
        elif message_type == 'queue_status_request':
            await self.send_queue_status()
```
- ê·¸ë£¹ ê¸°ë°˜ ë¸Œë¡œë“œìºìŠ¤íŒ… âœ“
- JSON ë©”ì‹œì§€ ì²˜ë¦¬ âœ“
- Ping/Pong ì—°ê²° ìœ ì§€ âœ“

1.3 ê´€ë¦¬ì ëŒ€ì‹œë³´ë“œ Consumer
```python
class DashboardConsumer(AsyncJsonWebsocketConsumer):
    async def connect(self):
        # ì£¼ê¸°ì  ì—…ë°ì´íŠ¸ ì„¤ì •
        self.update_task = asyncio.create_task(self.periodic_update())
        
    async def periodic_update(self):
        while True:
            await asyncio.sleep(30)
            await self.send_dashboard_data()
```
- ì£¼ê¸°ì  ë°ì´í„° ì—…ë°ì´íŠ¸ âœ“
- ì—­í•  ê¸°ë°˜ ì ‘ê·¼ ì œì–´ (ë¶€ë¶„) âœ“

ã€âš ï¸ ë¬¸ì œê°€ ìˆëŠ” ë¶€ë¶„ã€‘

1.4 ì¸ì¦ ì²˜ë¦¬ ë¶€ì¬
```python
# asgi.py
# JWT ì¸ì¦ ë¹„í™œì„±í™” ìƒíƒœ
"""
# TODO: JWT ì¸ì¦ êµ¬í˜„ í•„ìš”
try:
    from .middleware.websocket_auth import JWTAuthMiddleware
    application = ProtocolTypeRouter({
        "websocket": JWTAuthMiddleware(
            URLRouter(websocket_urlpatterns)
        ),
    })
except ImportError:
    pass  # ì¸ì¦ ì—†ì´ ì§„í–‰
"""
```

1.5 URL ë§¤í•‘ ë¶ˆì¼ì¹˜
```python
# ë°±ì—”ë“œ ë¼ìš°íŒ…
re_path(r'^ws/queue/(?P<queue_id>[\w-]+)/?$', ...)

# í”„ë¡ íŠ¸ì—”ë“œ ì‚¬ìš©
ws://localhost:8000/ws/journey/${userId}/  # ì¡´ì¬í•˜ì§€ ì•ŠëŠ” ì—”ë“œí¬ì¸íŠ¸
ws://localhost:8000/ws/patient-journey/    # ì¡´ì¬í•˜ì§€ ì•ŠëŠ” ì—”ë“œí¬ì¸íŠ¸
```

1.6 ì—ëŸ¬ ì²˜ë¦¬ ë¯¸í¡
```python
async def receive_json(self, content):
    try:
        # ì²˜ë¦¬ ë¡œì§
    except Exception as e:
        logger.error(f"Error: {e}")
        # í´ë¼ì´ì–¸íŠ¸ì—ê²Œ ì—ëŸ¬ ì•Œë¦¼ ì—†ìŒ
```

================================================================================
2. í”„ë¡ íŠ¸ì—”ë“œ WebSocket ì‹œìŠ¤í…œ
================================================================================

ã€âœ… ì˜ êµ¬í˜„ëœ ë¶€ë¶„ã€‘

2.1 WebSocket ì„œë¹„ìŠ¤ í´ë˜ìŠ¤
```javascript
class WebSocketService {
    constructor() {
        this.ws = null;
        this.callbacks = {};
        this.reconnectAttempts = 0;
        this.maxReconnectAttempts = 5;
    }
    
    connect(url) {
        this.ws = new WebSocket(url);
        this.setupEventHandlers();
    }
    
    on(event, callback) {
        if (!this.callbacks[event]) {
            this.callbacks[event] = [];
        }
        this.callbacks[event].push(callback);
    }
}
```
- ì‹±ê¸€í†¤ íŒ¨í„´ êµ¬í˜„ âœ“
- ì´ë²¤íŠ¸ ê¸°ë°˜ ì•„í‚¤í…ì²˜ âœ“
- ì½œë°± ê´€ë¦¬ ì‹œìŠ¤í…œ âœ“

2.2 useWebSocket Hook
```javascript
const useWebSocket = (url, options = {}) => {
    const [isConnected, setIsConnected] = useState(false);
    const [lastMessage, setLastMessage] = useState(null);
    const ws = useRef(null);
    
    useEffect(() => {
        ws.current = new WebSocket(url);
        
        ws.current.onopen = () => setIsConnected(true);
        ws.current.onmessage = (event) => {
            const data = JSON.parse(event.data);
            setLastMessage(data);
        };
        
        return () => ws.current?.close();
    }, [url]);
    
    return { isConnected, lastMessage, sendMessage };
};
```
- React Hook íŒ¨í„´ âœ“
- ìƒíƒœ ê´€ë¦¬ âœ“
- ìë™ ì •ë¦¬ âœ“

ã€âš ï¸ ë¬¸ì œê°€ ìˆëŠ” ë¶€ë¶„ã€‘

2.3 í•˜ë“œì½”ë”©ëœ URL
```javascript
// websocketService.js
const wsUrl = 'ws://127.0.0.1:8000/ws/queue/';  // í•˜ë“œì½”ë”©

// usePatientJourney.js
const wsUrl = `ws://localhost:8000/ws/journey/${userId}/`;  // ì¡´ì¬í•˜ì§€ ì•ŠëŠ” URL
```

2.4 ì¬ì—°ê²° ë©”ì»¤ë‹ˆì¦˜ ë¶ˆì™„ì „
```javascript
reconnect() {
    if (this.reconnectAttempts >= this.maxReconnectAttempts) {
        console.error('Max reconnection attempts reached');
        return;  // ì˜êµ¬ ì¤‘ë‹¨
    }
    
    setTimeout(() => {
        this.connect();
        this.reconnectAttempts++;
    }, 3000);  // ê³ ì •ëœ 3ì´ˆ ë”œë ˆì´
}
```

2.5 ì¸ì¦ í† í° ì²˜ë¦¬ ë¶€ì¬
```javascript
// WebSocket ì—°ê²° ì‹œ JWT í† í° ë¯¸í¬í•¨
const ws = new WebSocket(url);
// Authorization í—¤ë”ë‚˜ ì¿¼ë¦¬ íŒŒë¼ë¯¸í„°ë¡œ í† í° ì „ì†¡ í•„ìš”
```

2.6 ë©”ì‹œì§€ íì‰ ë¶€ì¬
```javascript
sendMessage(data) {
    if (this.ws?.readyState === WebSocket.OPEN) {
        this.ws.send(JSON.stringify(data));
    }
    // ì—°ê²° ëŠê¹€ ì‹œ ë©”ì‹œì§€ ì†ì‹¤
}
```

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸ”¥ ì£¼ìš” ë¬¸ì œì  ë° ì˜í–¥ë„
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ë¬¸ì œì                 â”‚ ì‹¬ê°ë„ â”‚ ì˜í–¥ ë²”ìœ„      â”‚ ìˆ˜ì • ì‹œê°„ â”‚ ìš°ì„ ìˆœìœ„ â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ URL ë§¤í•‘ ë¶ˆì¼ì¹˜       â”‚ ë§¤ìš°ë†’ìŒâ”‚ ì „ì²´ ê¸°ëŠ¥     â”‚ 0.5ì¼     â”‚ P1      â”‚
â”‚ ì¸ì¦ ì²˜ë¦¬ ë¶€ì¬        â”‚ ë†’ìŒ   â”‚ ë³´ì•ˆ          â”‚ 2ì¼       â”‚ P1      â”‚
â”‚ ì¬ì—°ê²° ë©”ì»¤ë‹ˆì¦˜ ë¶€ì¡±  â”‚ ë†’ìŒ   â”‚ ì•ˆì •ì„±        â”‚ 1ì¼       â”‚ P1      â”‚
â”‚ ë©”ì‹œì§€ íì‰ ë¶€ì¬      â”‚ ì¤‘ê°„   â”‚ ë°ì´í„° ë¬´ê²°ì„±  â”‚ 1ì¼       â”‚ P2      â”‚
â”‚ ì—ëŸ¬ ì²˜ë¦¬ ë¯¸í¡        â”‚ ì¤‘ê°„   â”‚ ì‚¬ìš©ì ê²½í—˜   â”‚ 0.5ì¼     â”‚ P2      â”‚
â”‚ í•˜ë“œì½”ë”©ëœ ì„¤ì •       â”‚ ë‚®ìŒ   â”‚ ìœ ì§€ë³´ìˆ˜      â”‚ 0.5ì¼     â”‚ P3      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸ’¡ ê°œì„  ë°©ì•ˆ (ìš°ì„ ìˆœìœ„ìˆœ)
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

================================================================================
[P1] URL ë§¤í•‘ í†µì¼ (0.5ì¼)
================================================================================

ã€ë°±ì—”ë“œ ë¼ìš°íŒ… ìˆ˜ì •ã€‘
```python
# routing.py
websocket_urlpatterns = [
    # í†µì¼ëœ URL íŒ¨í„´
    re_path(r'^ws/queue/?$', QueueConsumer.as_asgi()),
    re_path(r'^ws/journey/?$', PatientJourneyConsumer.as_asgi()),
    re_path(r'^ws/admin/?$', AdminDashboardConsumer.as_asgi()),
    
    # í•˜ìœ„ í˜¸í™˜ì„± ìœ ì§€
    re_path(r'^ws/queue/(?P<queue_id>[\w-]+)/?$', QueueConsumer.as_asgi()),
]

# ìƒˆë¡œìš´ PatientJourneyConsumer ìƒì„±
class PatientJourneyConsumer(AsyncJsonWebsocketConsumer):
    async def connect(self):
        # í† í°ì—ì„œ user_id ì¶”ì¶œ
        self.user = await self.get_user_from_token()
        if self.user:
            self.room_group_name = f'user_{self.user.id}'
            await self.channel_layer.group_add(
                self.room_group_name,
                self.channel_name
            )
            await self.accept()
        else:
            await self.close(code=4001)  # ì¸ì¦ ì‹¤íŒ¨
```

ã€í”„ë¡ íŠ¸ì—”ë“œ URL ì„¤ì •ã€‘
```javascript
// config.js
const WS_BASE_URL = process.env.NODE_ENV === 'production'
    ? 'wss://api.nfc-hospital.kr'
    : 'ws://localhost:8000';

const WS_ENDPOINTS = {
    QUEUE: `${WS_BASE_URL}/ws/queue/`,
    JOURNEY: `${WS_BASE_URL}/ws/journey/`,
    ADMIN: `${WS_BASE_URL}/ws/admin/`
};

// usePatientJourney.js
const wsUrl = WS_ENDPOINTS.JOURNEY;
```

================================================================================
[P1] JWT ì¸ì¦ êµ¬í˜„ (2ì¼)
================================================================================

ã€ë°±ì—”ë“œ ì¸ì¦ ë¯¸ë“¤ì›¨ì–´ã€‘
```python
# middleware/websocket_auth.py
from channels.auth import AuthMiddlewareStack
from channels.db import database_sync_to_async
from django.contrib.auth.models import AnonymousUser
import jwt

class JWTAuthMiddleware:
    def __init__(self, inner):
        self.inner = inner
    
    async def __call__(self, scope, receive, send):
        # ì¿¼ë¦¬ íŒŒë¼ë¯¸í„°ì—ì„œ í† í° ì¶”ì¶œ
        query_string = scope.get('query_string', b'').decode()
        params = dict(param.split('=') for param in query_string.split('&') if '=' in param)
        token = params.get('token')
        
        if not token:
            # í—¤ë”ì—ì„œ í† í° ì¶”ì¶œ (Sec-WebSocket-Protocol)
            headers = dict(scope['headers'])
            protocols = headers.get(b'sec-websocket-protocol', b'').decode()
            if 'jwt.' in protocols:
                token = protocols.split('jwt.')[1].split(',')[0]
        
        # í† í° ê²€ì¦
        user = await self.get_user_from_token(token)
        scope['user'] = user
        
        return await self.inner(scope, receive, send)
    
    @database_sync_to_async
    def get_user_from_token(self, token):
        if not token:
            return AnonymousUser()
        
        try:
            payload = jwt.decode(token, settings.SECRET_KEY, algorithms=['HS256'])
            user_id = payload.get('user_id')
            
            from authentication.models import User
            user = User.objects.get(user_id=user_id)
            return user
        except (jwt.DecodeError, User.DoesNotExist):
            return AnonymousUser()

# asgi.py ìˆ˜ì •
from .middleware.websocket_auth import JWTAuthMiddleware

application = ProtocolTypeRouter({
    "http": django_asgi_app,
    "websocket": JWTAuthMiddleware(
        URLRouter(websocket_urlpatterns)
    ),
})
```

ã€í”„ë¡ íŠ¸ì—”ë“œ í† í° ì „ì†¡ã€‘
```javascript
// websocketService.js
class AuthenticatedWebSocketService {
    connect(endpoint) {
        const token = localStorage.getItem('access_token');
        
        // ë°©ë²• 1: ì¿¼ë¦¬ íŒŒë¼ë¯¸í„°
        const url = `${endpoint}?token=${token}`;
        
        // ë°©ë²• 2: ì„œë¸Œí”„ë¡œí† ì½œ (ê¶Œì¥)
        this.ws = new WebSocket(endpoint, [`jwt.${token}`]);
        
        this.ws.onopen = () => {
            console.log('Authenticated WebSocket connected');
        };
        
        this.ws.onerror = (error) => {
            if (error.code === 4001) {
                // ì¸ì¦ ì‹¤íŒ¨ - í† í° ê°±ì‹  ì‹œë„
                this.refreshTokenAndReconnect();
            }
        };
    }
    
    async refreshTokenAndReconnect() {
        try {
            const newToken = await authAPI.refreshToken();
            localStorage.setItem('access_token', newToken);
            this.connect(this.endpoint);
        } catch (error) {
            // ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸
            window.location.href = '/login';
        }
    }
}
```

================================================================================
[P1] ì¬ì—°ê²° ë©”ì»¤ë‹ˆì¦˜ ê°•í™” (1ì¼)
================================================================================

ã€ì§€ìˆ˜ ë°±ì˜¤í”„ ì¬ì—°ê²°ã€‘
```javascript
class RobustWebSocketService {
    constructor() {
        this.reconnectAttempts = 0;
        this.maxReconnectAttempts = 10;
        this.reconnectTimer = null;
        this.messageQueue = [];
        this.isIntentionallyClosed = false;
    }
    
    connect(endpoint) {
        this.endpoint = endpoint;
        this.isIntentionallyClosed = false;
        
        try {
            const token = localStorage.getItem('access_token');
            this.ws = new WebSocket(endpoint, [`jwt.${token}`]);
            
            this.ws.onopen = () => {
                console.log('WebSocket connected');
                this.reconnectAttempts = 0;
                
                // íì— ìˆë˜ ë©”ì‹œì§€ ì „ì†¡
                this.flushMessageQueue();
                
                // ì—°ê²° ì„±ê³µ ì½œë°±
                this.onConnected?.();
            };
            
            this.ws.onclose = (event) => {
                if (!this.isIntentionallyClosed) {
                    this.scheduleReconnect();
                }
            };
            
            this.ws.onerror = (error) => {
                console.error('WebSocket error:', error);
                this.onError?.(error);
            };
            
            this.ws.onmessage = (event) => {
                this.handleMessage(event.data);
            };
            
        } catch (error) {
            console.error('WebSocket creation failed:', error);
            this.scheduleReconnect();
        }
    }
    
    scheduleReconnect() {
        if (this.reconnectAttempts >= this.maxReconnectAttempts) {
            console.error('Max reconnection attempts reached');
            this.onMaxReconnectFailed?.();
            return;
        }
        
        // ì§€ìˆ˜ ë°±ì˜¤í”„: 1s, 2s, 4s, 8s, 16s, 32s, 60s (max)
        const delay = Math.min(
            1000 * Math.pow(2, this.reconnectAttempts),
            60000
        );
        
        console.log(`Reconnecting in ${delay/1000}s (attempt ${this.reconnectAttempts + 1})`);
        
        this.reconnectTimer = setTimeout(() => {
            this.reconnectAttempts++;
            this.connect(this.endpoint);
        }, delay);
    }
    
    sendMessage(data) {
        const message = JSON.stringify(data);
        
        if (this.ws?.readyState === WebSocket.OPEN) {
            this.ws.send(message);
        } else {
            // ì—°ê²° ëŠê¹€ ì‹œ íì— ì €ì¥
            this.messageQueue.push(message);
            console.log('Message queued, will send when reconnected');
        }
    }
    
    flushMessageQueue() {
        while (this.messageQueue.length > 0) {
            const message = this.messageQueue.shift();
            this.ws.send(message);
        }
    }
    
    close() {
        this.isIntentionallyClosed = true;
        clearTimeout(this.reconnectTimer);
        this.ws?.close();
    }
}
```

================================================================================
[P2] ë©”ì‹œì§€ íì‰ ë° ìˆœì„œ ë³´ì¥ (1ì¼)
================================================================================

ã€ë©”ì‹œì§€ í ì‹œìŠ¤í…œã€‘
```javascript
class MessageQueue {
    constructor(maxSize = 100) {
        this.queue = [];
        this.maxSize = maxSize;
        this.sequenceNumber = 0;
    }
    
    enqueue(message) {
        if (this.queue.length >= this.maxSize) {
            this.queue.shift();  // ì˜¤ë˜ëœ ë©”ì‹œì§€ ì œê±°
        }
        
        const envelope = {
            seq: ++this.sequenceNumber,
            timestamp: Date.now(),
            message: message,
            retryCount: 0
        };
        
        this.queue.push(envelope);
        return envelope;
    }
    
    dequeue() {
        return this.queue.shift();
    }
    
    getAll() {
        return [...this.queue];
    }
    
    clear() {
        this.queue = [];
    }
}

class ReliableWebSocketService {
    constructor() {
        this.outgoingQueue = new MessageQueue();
        this.acknowledgements = new Map();
        this.ackTimeout = 5000;  // 5ì´ˆ
    }
    
    sendMessage(data) {
        const envelope = this.outgoingQueue.enqueue(data);
        
        if (this.ws?.readyState === WebSocket.OPEN) {
            this.sendEnvelope(envelope);
        }
    }
    
    sendEnvelope(envelope) {
        const message = {
            ...envelope.message,
            _seq: envelope.seq,
            _timestamp: envelope.timestamp
        };
        
        this.ws.send(JSON.stringify(message));
        
        // ACK ëŒ€ê¸°
        const ackTimer = setTimeout(() => {
            this.handleMissingAck(envelope);
        }, this.ackTimeout);
        
        this.acknowledgements.set(envelope.seq, {
            envelope,
            timer: ackTimer
        });
    }
    
    handleMessage(rawData) {
        const data = JSON.parse(rawData);
        
        // ACK ì²˜ë¦¬
        if (data.type === 'ack') {
            const ack = this.acknowledgements.get(data.seq);
            if (ack) {
                clearTimeout(ack.timer);
                this.acknowledgements.delete(data.seq);
            }
            return;
        }
        
        // ì¼ë°˜ ë©”ì‹œì§€ ì²˜ë¦¬
        this.processMessage(data);
        
        // ACK ì „ì†¡
        if (data._seq) {
            this.ws.send(JSON.stringify({
                type: 'ack',
                seq: data._seq
            }));
        }
    }
    
    handleMissingAck(envelope) {
        console.warn(`No ACK for message ${envelope.seq}, retrying...`);
        
        envelope.retryCount++;
        if (envelope.retryCount < 3) {
            this.sendEnvelope(envelope);
        } else {
            console.error(`Message ${envelope.seq} failed after 3 retries`);
            this.onMessageFailed?.(envelope);
        }
    }
}
```

================================================================================
[P2] ì—ëŸ¬ ì²˜ë¦¬ ê°•í™” (0.5ì¼)
================================================================================

ã€ë°±ì—”ë“œ ì—ëŸ¬ ì²˜ë¦¬ã€‘
```python
class ImprovedConsumer(AsyncJsonWebsocketConsumer):
    async def receive_json(self, content):
        try:
            message_type = content.get('type')
            
            if not message_type:
                await self.send_error('Missing message type')
                return
            
            handler = getattr(self, f'handle_{message_type}', None)
            if handler:
                await handler(content)
            else:
                await self.send_error(f'Unknown message type: {message_type}')
                
        except ValidationError as e:
            await self.send_error('Validation error', details=str(e))
        except PermissionDenied as e:
            await self.send_error('Permission denied', code=4003)
        except Exception as e:
            logger.exception('Unexpected error in WebSocket consumer')
            await self.send_error('Internal server error', code=5000)
    
    async def send_error(self, message, code=4000, details=None):
        await self.send_json({
            'type': 'error',
            'error': {
                'message': message,
                'code': code,
                'details': details,
                'timestamp': timezone.now().isoformat()
            }
        })
```

ã€í”„ë¡ íŠ¸ì—”ë“œ ì—ëŸ¬ ì²˜ë¦¬ã€‘
```javascript
class ErrorHandlingWebSocket {
    handleMessage(event) {
        try {
            const data = JSON.parse(event.data);
            
            if (data.type === 'error') {
                this.handleError(data.error);
                return;
            }
            
            this.processMessage(data);
            
        } catch (error) {
            console.error('Failed to parse WebSocket message:', error);
            this.onParseError?.(event.data);
        }
    }
    
    handleError(error) {
        console.error(`WebSocket error: ${error.message} (${error.code})`);
        
        switch (error.code) {
            case 4001:  // ì¸ì¦ ì‹¤íŒ¨
                this.handleAuthError();
                break;
            case 4003:  // ê¶Œí•œ ì—†ìŒ
                this.showPermissionError();
                break;
            case 5000:  // ì„œë²„ ì˜¤ë¥˜
                this.showServerError();
                break;
            default:
                this.showGenericError(error.message);
        }
    }
    
    showPermissionError() {
        // ì‚¬ìš©ì ì¹œí™”ì  ì—ëŸ¬ ë©”ì‹œì§€
        toast.error('ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤. ë‹¤ì‹œ ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”.');
    }
    
    showServerError() {
        toast.error('ì„œë²„ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
    }
}
```

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸ“Š ê°œì„  í›„ ì˜ˆìƒ íš¨ê³¼
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

ã€ì—°ê²° ì•ˆì •ì„±ã€‘
â€¢ ì¬ì—°ê²° ì„±ê³µë¥  60% â†’ 95%
â€¢ í‰ê·  ì¬ì—°ê²° ì‹œê°„ 30ì´ˆ â†’ 5ì´ˆ
â€¢ ë©”ì‹œì§€ ì†ì‹¤ë¥  10% â†’ 0.1%

ã€ë³´ì•ˆì„±ã€‘
â€¢ JWT ê¸°ë°˜ ì¸ì¦ìœ¼ë¡œ ë¬´ë‹¨ ì ‘ê·¼ ì°¨ë‹¨
â€¢ ì—­í•  ê¸°ë°˜ ì ‘ê·¼ ì œì–´ êµ¬í˜„
â€¢ í† í° ìë™ ê°±ì‹ ìœ¼ë¡œ ì„¸ì…˜ ìœ ì§€

ã€ì‚¬ìš©ì ê²½í—˜ã€‘
â€¢ ì‹¤ì‹œê°„ ì—…ë°ì´íŠ¸ ì§€ì—° 0.1ì´ˆ ì´ë‚´
â€¢ ë„¤íŠ¸ì›Œí¬ ì¥ì•  ì‹œ ìë™ ë³µêµ¬
â€¢ ëª…í™•í•œ ì—ëŸ¬ ë©”ì‹œì§€ ì œê³µ

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
âœ… ì²´í¬ë¦¬ìŠ¤íŠ¸
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

ã€í•„ìˆ˜ êµ¬í˜„ (1ì£¼ ë‚´)ã€‘
â–¡ URL ë§¤í•‘ í†µì¼
â–¡ JWT ì¸ì¦ ë¯¸ë“¤ì›¨ì–´
â–¡ ì§€ìˆ˜ ë°±ì˜¤í”„ ì¬ì—°ê²°
â–¡ ê¸°ë³¸ ì—ëŸ¬ ì²˜ë¦¬

ã€ì„ íƒ êµ¬í˜„ (ì—¬ìœ  ìˆì„ ë•Œ)ã€‘
â–¡ ë©”ì‹œì§€ íì‰ ì‹œìŠ¤í…œ
â–¡ ACK ê¸°ë°˜ ì‹ ë¢°ì„± ë³´ì¥
â–¡ ì—°ê²° í’€ë§
â–¡ ë©”ì‹œì§€ ì••ì¶•

ã€í…ŒìŠ¤íŠ¸ í•­ëª©ã€‘
â–¡ ì—°ê²°/ì¬ì—°ê²° ì‹œë‚˜ë¦¬ì˜¤
â–¡ ì¸ì¦ ì‹¤íŒ¨ ì²˜ë¦¬
â–¡ ë„¤íŠ¸ì›Œí¬ ì¥ì•  ë³µêµ¬
â–¡ ë™ì‹œ ì ‘ì† ë¶€í•˜
â–¡ ë©”ì‹œì§€ ìˆœì„œ ë³´ì¥

================================================================================
ê²°ë¡ : WebSocket ì‹œìŠ¤í…œì€ ê¸°ë³¸ êµ¬ì¡°ëŠ” ê°–ì¶”ì—ˆìœ¼ë‚˜,
     í”„ë¡œë•ì…˜ í™˜ê²½ì„ ìœ„í•œ ì•ˆì •ì„±ê³¼ ë³´ì•ˆ ê°•í™”ê°€ ì‹œê¸‰í•¨
================================================================================