<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>LocalStorage ê²½ë¡œ â†’ DB ì—…ë¡œë“œ</title>
  <style>
    body {
      font-family: sans-serif;
      max-width: 1200px;
      margin: 40px auto;
      padding: 20px;
    }
    .route-item {
      border: 1px solid #ddd;
      padding: 15px;
      margin: 10px 0;
      border-radius: 8px;
      background: #f9f9f9;
    }
    .route-name {
      font-weight: bold;
      font-size: 18px;
      color: #333;
      margin-bottom: 10px;
    }
    .route-info {
      font-size: 14px;
      color: #666;
    }
    button {
      padding: 10px 20px;
      margin: 5px;
      cursor: pointer;
      border: none;
      border-radius: 5px;
      font-size: 14px;
    }
    .upload-btn {
      background: #22c55e;
      color: white;
    }
    .upload-btn:hover {
      background: #16a34a;
    }
    .upload-all-btn {
      background: #3b82f6;
      color: white;
      font-size: 16px;
      padding: 15px 30px;
      margin: 20px 0;
    }
    .upload-all-btn:hover {
      background: #2563eb;
    }
    .status {
      margin-top: 10px;
      padding: 10px;
      border-radius: 5px;
    }
    .success {
      background: #d1fae5;
      color: #065f46;
    }
    .error {
      background: #fee2e2;
      color: #991b1b;
    }
  </style>
</head>
<body>
  <h1>ğŸ“¤ LocalStorage ê²½ë¡œ â†’ DB ì—…ë¡œë“œ</h1>
  <p>LocalStorageì— ì €ì¥ëœ ëª¨ë“  ê²½ë¡œë¥¼ ì„œë²„ DBì— ì—…ë¡œë“œí•©ë‹ˆë‹¤.</p>

  <button class="upload-all-btn" onclick="uploadAllRoutes()">ğŸš€ ëª¨ë“  ê²½ë¡œ ì¼ê´„ ì—…ë¡œë“œ</button>

  <div id="routes-container"></div>

  <script>
    const API_BASE_URL = 'http://127.0.0.1:8000/api/v1';  // Vite ì„¤ì •ê³¼ ë™ì¼í•œ URL ì‚¬ìš©

    // LocalStorageì—ì„œ ëª¨ë“  ê²½ë¡œ ê°€ì ¸ì˜¤ê¸°
    function loadLocalRoutes() {
      const facilityRoutes = JSON.parse(localStorage.getItem('facilityRoutes') || '{}');
      const container = document.getElementById('routes-container');
      container.innerHTML = '';

      if (Object.keys(facilityRoutes).length === 0) {
        container.innerHTML = '<p>LocalStorageì— ì €ì¥ëœ ê²½ë¡œê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
        return;
      }

      console.log('ğŸ“¦ LocalStorage ê²½ë¡œ ëª©ë¡:', Object.keys(facilityRoutes));

      Object.entries(facilityRoutes).forEach(([name, data]) => {
        const div = document.createElement('div');
        div.className = 'route-item';
        div.id = `route-${name.replace(/\s/g, '-')}`;

        // Multi-floorì¸ì§€ í™•ì¸
        const isMultiFloor = data.maps && typeof data.maps === 'object';
        const mapsCount = isMultiFloor ? Object.keys(data.maps).length : 1;
        const nodeCount = isMultiFloor
          ? Object.values(data.maps).reduce((sum, map) => sum + (map.nodes?.length || 0), 0)
          : data.nodes?.length || 0;

        div.innerHTML = `
          <div class="route-name">${name}</div>
          <div class="route-info">
            ${isMultiFloor ? `ğŸ—ºï¸ Multi-floor (${mapsCount}ê°œ ë§µ)` : 'ğŸ“ ë‹¨ì¼ ë§µ'}
            | ë…¸ë“œ: ${nodeCount}ê°œ
            | ë§ˆì§€ë§‰ ì—…ë°ì´íŠ¸: ${data.lastUpdated ? new Date(data.lastUpdated).toLocaleString() : 'ì•Œ ìˆ˜ ì—†ìŒ'}
          </div>
          <button class="upload-btn" onclick="uploadRoute('${name}')">
            â¬†ï¸ DBì— ì—…ë¡œë“œ
          </button>
          <div id="status-${name.replace(/\s/g, '-')}" class="status" style="display:none;"></div>
        `;

        container.appendChild(div);
      });
    }

    // ê°œë³„ ê²½ë¡œ ì—…ë¡œë“œ
    async function uploadRoute(facilityName) {
      const facilityRoutes = JSON.parse(localStorage.getItem('facilityRoutes') || '{}');
      const routeData = facilityRoutes[facilityName];

      if (!routeData) {
        alert(`ê²½ë¡œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤: ${facilityName}`);
        return;
      }

      const statusDiv = document.getElementById(`status-${facilityName.replace(/\s/g, '-')}`);
      statusDiv.style.display = 'block';
      statusDiv.className = 'status';
      statusDiv.textContent = 'ì—…ë¡œë“œ ì¤‘...';

      try {
        // Multi-floor í˜•ì‹ í™•ì¸
        const isMultiFloor = routeData.maps && typeof routeData.maps === 'object';

        const payload = isMultiFloor ? {
          facility_name: facilityName,
          nodes: [],
          edges: [],
          map_id: routeData.currentMap || Object.keys(routeData.maps)[0] || 'main_1f',
          svg_element_id: '',
          metadata: {
            maps: routeData.maps,
            currentMap: routeData.currentMap,
            isMultiFloor: true,
            routeName: facilityName,
            createdAt: routeData.lastUpdated || new Date().toISOString()
          }
        } : {
          facility_name: facilityName,
          nodes: routeData.nodes || [],
          edges: routeData.edges || [],
          map_id: routeData.mapId || 'main_1f',
          svg_element_id: '',
          start_node: routeData.startNode || null,
          end_node: routeData.endNode || null,
          node_types: routeData.nodeTypes || {},
          node_transitions: routeData.nodeTransitions || {}
        };

        console.log(`ğŸ“¤ ì—…ë¡œë“œ ì‹œì‘: ${facilityName}`, payload);

        const response = await fetch(`${API_BASE_URL}/nfc/facility-routes/save_route/`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(payload)
        });

        const result = await response.json();

        if (response.ok) {
          statusDiv.className = 'status success';
          statusDiv.textContent = `âœ… ì—…ë¡œë“œ ì„±ê³µ! ${result.message}`;
          console.log(`âœ… ${facilityName} ì—…ë¡œë“œ ì™„ë£Œ:`, result);
        } else {
          throw new Error(result.error || 'ì—…ë¡œë“œ ì‹¤íŒ¨');
        }
      } catch (error) {
        statusDiv.className = 'status error';
        statusDiv.textContent = `âŒ ì—…ë¡œë“œ ì‹¤íŒ¨: ${error.message}`;
        console.error(`âŒ ${facilityName} ì—…ë¡œë“œ ì‹¤íŒ¨:`, error);
      }
    }

    // ëª¨ë“  ê²½ë¡œ ì¼ê´„ ì—…ë¡œë“œ
    async function uploadAllRoutes() {
      if (!confirm('ëª¨ë“  ê²½ë¡œë¥¼ DBì— ì—…ë¡œë“œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
        return;
      }

      const facilityRoutes = JSON.parse(localStorage.getItem('facilityRoutes') || '{}');
      const routeNames = Object.keys(facilityRoutes);

      console.log(`ğŸš€ ${routeNames.length}ê°œ ê²½ë¡œ ì¼ê´„ ì—…ë¡œë“œ ì‹œì‘`);

      let successCount = 0;
      let failCount = 0;

      for (const name of routeNames) {
        try {
          await uploadRoute(name);
          successCount++;
          await new Promise(resolve => setTimeout(resolve, 500)); // 0.5ì´ˆ ëŒ€ê¸°
        } catch (error) {
          failCount++;
          console.error(`ì‹¤íŒ¨: ${name}`, error);
        }
      }

      alert(`ì—…ë¡œë“œ ì™„ë£Œ!\nì„±ê³µ: ${successCount}ê°œ\nì‹¤íŒ¨: ${failCount}ê°œ`);
    }

    // í˜ì´ì§€ ë¡œë“œì‹œ ê²½ë¡œ ëª©ë¡ í‘œì‹œ
    loadLocalRoutes();
  </script>
</body>
</html>
