name: Deploy to EC2

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Deploy Backend to EC2
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.EC2_HOST }}
        username: ${{ secrets.EC2_USER }}
        key: ${{ secrets.EC2_SSH_KEY }}
        script: |
          # --- (최종 안정화) Django 배포 스크립트 ---

          # 경로 변수 정의
          PROJECT_DIR="$HOME/nfc-hospital"
          BACKEND_DIR="$PROJECT_DIR/backend"
          VENV_GUNICORN="$BACKEND_DIR/venv/bin/gunicorn"
          VENV_PIP="$BACKEND_DIR/venv/bin/pip"
          DJANGO_DIR="$BACKEND_DIR/nfc_hospital_system"
          PID_FILE="$BACKEND_DIR/gunicorn.pid"

          # 1. 코드 업데이트
          echo ">>> 1. Pulling latest code..."
          cd $PROJECT_DIR
          git pull origin main
          
          # 2. 파이썬 의존성 설치
          echo ">>> 2. Installing Python dependencies..."
          $VENV_PIP install -r $DJANGO_DIR/requirements.txt
          
          # 3. 이전 서버 안전하게 종료 (PID 파일 우선, 대체 pkill 로직 수정)
          echo ">>> 3. Safely stopping the old server..."
          if [ -f $PID_FILE ]; then
            echo "PID file found. Killing process $(cat $PID_FILE)..."
            kill $(cat $PID_FILE)
            rm $PID_FILE
            sleep 2
          else
            echo "PID file not found. Killing gunicorn by full path..."
            # Gunicorn 실행 파일 경로로 시작하는 프로세스만 정확히 종료 (가장 안전한 pkill 방식)
            pkill -f "^$VENV_GUNICORN" || true
            sleep 2
          fi
          
          # 4. 새 서버 시작 (PID 파일 생성 옵션 추가)
          echo ">>> 4. Starting new server with Gunicorn..."
          cd $DJANGO_DIR
          screen -dmS django $VENV_GUNICORN \
            --workers 3 \
            --bind 0.0.0.0:8000 \
            --pid $PID_FILE \
            nfc_hospital_system.wsgi:application \
            --settings=nfc_hospital_system.settings.development
          
          # 5. 서버 상태 검증
          echo ">>> 5. Verifying server status..."
          sleep 5
          
          if screen -list | grep -q "django"; then
            echo "✅ Screen session 'django' is running."
          else
            echo "❌ ERROR: Screen session 'django' failed to start."
            exit 1
          fi
          
          if curl -f http://localhost:8000/ > /dev/null 2>&1; then
              echo "✅ Success: Django server is up and running!"
          else
              echo "❌ ERROR: Django server is not responding."
              echo "--- Displaying last 20 lines of the screen log for debugging ---"
              screen -S django -X hardcopy .screen-log.txt && tail -n 20 .screen-log.txt
              exit 1
          fi
