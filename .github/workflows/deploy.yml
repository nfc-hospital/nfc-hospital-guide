name: Deploy Full Stack to EC2

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Deploy Full Stack to EC2
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.EC2_HOST }}
        username: ${{ secrets.EC2_USER }}
        key: ${{ secrets.EC2_SSH_KEY }}
        script: |
          set -e # ëª…ë ¹ì–´ ì‹¤íŒ¨ ì‹œ ì¦‰ì‹œ ì¤‘ë‹¨

          # --- ê²½ë¡œ ë³€ìˆ˜ ì •ì˜ ---
          PROJECT_DIR="$HOME/nfc-hospital"
          BACKEND_DIR="$PROJECT_DIR/backend"
          FRONTEND_DIR="$PROJECT_DIR/frontend-pwa"
          VENV_DAPHNE="$BACKEND_DIR/venv/bin/daphne"
          VENV_PIP="$BACKEND_DIR/venv/bin/pip"
          VENV_PYTHON="$BACKEND_DIR/venv/bin/python"
          DJANGO_DIR="$BACKEND_DIR/nfc_hospital_system"
          FRONTEND_BUILD_PATH="/var/www/nfc-hospital"
          EC2_HOST="15.164.94.194"

          # --- 1. ì½”ë“œ ì—…ë°ì´íŠ¸ ---
          echo ">>> 1. Updating code from repository..."
          cd $PROJECT_DIR
          git reset --hard HEAD
          git pull origin main

          # --- 2. ë°±ì—”ë“œ ì˜ì¡´ì„± ì„¤ì¹˜ ---
          echo ">>> 2. Installing backend dependencies..."
          cd $DJANGO_DIR
          $VENV_PIP install -r requirements.txt

          # --- 3. í”„ë¡ íŠ¸ì—”ë“œ ì˜ì¡´ì„± ì„¤ì¹˜ ë° ë¹Œë“œ ---
          echo ">>> 3. Installing frontend dependencies and building..."
          cd $FRONTEND_DIR
          npm install
          npm run build

          # --- 4. Django ì• í”Œë¦¬ì¼€ì´ì…˜ ì¤€ë¹„ ---
          echo ">>> 4. Preparing Django application..."
          cd $DJANGO_DIR
          
          # production ì„¤ì •ìœ¼ë¡œ ëª…ì‹œì  ì‹¤í–‰
          export DJANGO_SETTINGS_MODULE="nfc_hospital_system.settings.production"
          
          $VENV_PYTHON manage.py collectstatic --noinput
          $VENV_PYTHON manage.py migrate --noinput

          # --- 5. ë¡œê·¸ ë””ë ‰í„°ë¦¬ ìƒì„± (ì¤‘ìš”!) ---
          echo ">>> 5. Creating log directories for Django..."
          sudo mkdir -p /var/log/django
          sudo chown $USER:$USER /var/log/django
          sudo chmod 755 /var/log/django

          # --- 6. ë°±ì—”ë“œ ì„œë²„ ì¬ì‹œì‘ ---
          echo ">>> 6. Restarting backend server..."
          # ê¸°ì¡´ ì„œë²„ ì¢…ë£Œ
          screen -S django -X quit || true
          pkill -f "daphne" || true
          sleep 2
          
          # production í™˜ê²½ìœ¼ë¡œ Daphne ì‹¤í–‰
          cd $DJANGO_DIR
          screen -dmS django bash -c "export DJANGO_SETTINGS_MODULE='nfc_hospital_system.settings.production'; $VENV_DAPHNE -b 127.0.0.1 -p 8000 nfc_hospital_system.asgi:application"

          # --- 7. Nginx ì„¤ì • ---
          echo ">>> 7. Configuring Nginx..."
          
          # Nginx ì„¤ì • íŒŒì¼ ìƒì„±
          sudo tee /etc/nginx/sites-available/nfc-hospital > /dev/null <<'EOF'
server {
    listen 80;
    server_name 15.164.94.194;
    
    # íƒ€ì„ì•„ì›ƒ ì„¤ì •
    proxy_connect_timeout 60s;
    proxy_send_timeout 60s;
    proxy_read_timeout 60s;
    
    # í”„ë¡ íŠ¸ì—”ë“œ
    location / {
        root /var/www/nfc-hospital;
        try_files $uri $uri/ /index.html;
        add_header Cache-Control "no-cache, no-store, must-revalidate";
    }
    
    # ë°±ì—”ë“œ API, Admin, WebSocket
    location ~ ^/(api|admin|ws|static)/ {
        proxy_pass http://127.0.0.1:8000;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
}
EOF

          # Nginx ì‚¬ì´íŠ¸ í™œì„±í™”
          sudo ln -sf /etc/nginx/sites-available/nfc-hospital /etc/nginx/sites-enabled/
          sudo rm -f /etc/nginx/sites-enabled/default

          # --- 8. í”„ë¡ íŠ¸ì—”ë“œ íŒŒì¼ ë³µì‚¬ ---
          echo ">>> 8. Copying frontend files..."
          sudo mkdir -p $FRONTEND_BUILD_PATH
          sudo rm -rf $FRONTEND_BUILD_PATH/*
          sudo cp -r $FRONTEND_DIR/dist/* $FRONTEND_BUILD_PATH/
          sudo chown -R www-data:www-data $FRONTEND_BUILD_PATH

          # --- 9. Nginx ì¬ì‹œì‘ ---
          echo ">>> 9. Restarting Nginx..."
          sudo nginx -t
          sudo systemctl restart nginx

          # --- 10. ìµœì¢… ê²€ì¦ ---
          echo ">>> 10. Verifying deployment..."
          sleep 5
          
          # Django ì„œë²„ í™•ì¸
          if screen -list | grep -q "django"; then
              echo "âœ… Backend server is running"
          else
              echo "âŒ ERROR: Backend server failed to start"
              echo "Checking for errors..."
              if [ -f /var/log/django/error.log ]; then
                  tail -20 /var/log/django/error.log
              fi
              exit 1
          fi
          
          # ì›¹ì‚¬ì´íŠ¸ ì‘ë‹µ í™•ì¸
          if curl -f http://localhost/ > /dev/null 2>&1; then
              echo "âœ… Frontend is responding"
          else
              echo "âŒ ERROR: Frontend is not responding"
              exit 1
          fi
          
          echo "ğŸ‰ Deployment completed successfully!"
          echo "ğŸŒ Website: http://$EC2_HOST/"
          echo "ğŸ”§ API: http://$EC2_HOST/api/"
          echo "âš™ï¸ Admin: http://$EC2_HOST/admin/"