name: Deploy Full Stack to EC2

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Deploy Full Stack to EC2
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.EC2_HOST }}
        username: ${{ secrets.EC2_USER }}
        key: ${{ secrets.EC2_SSH_KEY }}
        script: |
          # --- ÏµúÏ†ÅÌôîÎêú ÌíÄÏä§ÌÉù ÏûêÎèô Î∞∞Ìè¨ Ïä§ÌÅ¨Î¶ΩÌä∏ ---
          
          # Ïä§ÌÅ¨Î¶ΩÌä∏ ÏïàÏ†ïÏÑ± Í∞ïÌôî (Î™ÖÎ†πÏñ¥ Ïã§Ìå® Ïãú Ï¶âÏãú Ï§ëÎã®)
          set -e
          
          # Ï£ºÏöî Í≤ΩÎ°ú Î≥ÄÏàò Ï†ïÏùò
          PROJECT_DIR="$HOME/nfc-hospital"
          BACKEND_DIR="$PROJECT_DIR/backend"
          FRONTEND_DIR="$PROJECT_DIR/frontend-pwa"
          VENV_DAPHNE="$BACKEND_DIR/venv/bin/daphne"
          VENV_PIP="$BACKEND_DIR/venv/bin/pip"
          VENV_PYTHON="$BACKEND_DIR/venv/bin/python"
          DJANGO_DIR="$BACKEND_DIR/nfc_hospital_system"
          FRONTEND_BUILD_PATH="/var/www/nfc-hospital"
          EC2_HOST="15.164.94.194"
          
          echo "‚úÖ Using EC2_HOST: $EC2_HOST"
          echo "‚úÖ Using FRONTEND_BUILD_PATH: $FRONTEND_BUILD_PATH"
          
          # 1. ÌòÑÏû¨ HEAD Ï†ÄÏû•ÌïòÍ≥† ÏΩîÎìú ÏóÖÎç∞Ïù¥Ìä∏
          echo ">>> 1. Checking for changes..."
          cd $PROJECT_DIR
          
          # ÌòÑÏû¨ Ïª§Î∞ã Ìï¥Ïãú Ï†ÄÏû•
          CURRENT_COMMIT=$(git rev-parse HEAD 2>/dev/null || echo "none")
          echo "Current commit: $CURRENT_COMMIT"
          
          # ÏΩîÎìú ÏóÖÎç∞Ïù¥Ìä∏
          git reset --hard HEAD
          git pull origin main
          
          # ÏÉà Ïª§Î∞ã Ìï¥Ïãú
          NEW_COMMIT=$(git rev-parse HEAD)
          echo "New commit: $NEW_COMMIT"
          
          # Î≥ÄÍ≤ΩÎêú ÌååÏùº Î™©Î°ù ÌôïÏù∏
          if [ "$CURRENT_COMMIT" != "none" ] && [ "$CURRENT_COMMIT" != "$NEW_COMMIT" ]; then
              echo ">>> Analyzing changes..."
              CHANGED_FILES=$(git diff --name-only $CURRENT_COMMIT $NEW_COMMIT)
              echo "Changed files:"
              echo "$CHANGED_FILES"
              
              # Î≥ÄÍ≤Ω ÌîåÎûòÍ∑∏ ÏÑ§Ï†ï
              BACKEND_DEPS_CHANGED=$(echo "$CHANGED_FILES" | grep -E "(requirements\.txt|requirements-.*\.txt)" || true)
              FRONTEND_DEPS_CHANGED=$(echo "$CHANGED_FILES" | grep -E "frontend-pwa/package(-lock)?\.json" || true)
              FRONTEND_SRC_CHANGED=$(echo "$CHANGED_FILES" | grep -E "frontend-pwa/(src/|public/|index\.html|vite\.config|tsconfig)" || true)
              BACKEND_CODE_CHANGED=$(echo "$CHANGED_FILES" | grep -E "backend/.*\.py" || true)
              NGINX_CONFIG_CHANGED=$(echo "$CHANGED_FILES" | grep -E "nginx|deploy\.yml" || true)
          else
              echo ">>> First deployment or no previous commit found. Running full deployment."
              BACKEND_DEPS_CHANGED="true"
              FRONTEND_DEPS_CHANGED="true"
              FRONTEND_SRC_CHANGED="true"
              BACKEND_CODE_CHANGED="true"
              NGINX_CONFIG_CHANGED="true"
          fi
          
          # 2. Ï°∞Í±¥Î∂Ä Î∞±ÏóîÎìú ÏùòÏ°¥ÏÑ± ÏÑ§Ïπò
          if [ -n "$BACKEND_DEPS_CHANGED" ]; then
              echo ">>> 2. Backend dependencies changed. Installing..."
              $VENV_PIP install -r $DJANGO_DIR/requirements.txt
          else
              echo ">>> 2. Skipping backend dependency installation (no changes)"
          fi
          
          # 3. Ï°∞Í±¥Î∂Ä ÌîÑÎ°†Ìä∏ÏóîÎìú ÏùòÏ°¥ÏÑ± ÏÑ§Ïπò
          cd $FRONTEND_DIR
          if [ -n "$FRONTEND_DEPS_CHANGED" ]; then
              echo ">>> 3. Frontend dependencies changed. Installing..."
              npm install
          else
              echo ">>> 3. Skipping frontend dependency installation (no changes)"
          fi
          
          # 4. Ï°∞Í±¥Î∂Ä ÌîÑÎ°†Ìä∏ÏóîÎìú ÎπåÎìú
          if [ -n "$FRONTEND_SRC_CHANGED" ] || [ -n "$FRONTEND_DEPS_CHANGED" ]; then
              echo ">>> 4. Frontend source changed. Building..."
              npm run build
              
              # ÎπåÎìú ÌÉÄÏûÑÏä§ÌÉ¨ÌîÑ Ï∂îÍ∞Ä (Ï∫êÏãú Î¨¥Ìö®ÌôîÏö©)
              BUILD_TIMESTAMP=$(date +%s)
              echo "{\"buildTime\": \"$BUILD_TIMESTAMP\"}" > dist/build-info.json
          else
              echo ">>> 4. Skipping frontend build (no source changes)"
          fi
          
          # 5. Django Ï†ïÏ†Å ÌååÏùº ÏàòÏßë (ÌïÑÏöîÌïú Í≤ΩÏö∞Îßå)
          if [ -n "$BACKEND_CODE_CHANGED" ]; then
              echo ">>> 5. Collecting Django static files..."
              cd $DJANGO_DIR
              $VENV_PYTHON manage.py collectstatic --noinput || true
          else
              echo ">>> 5. Skipping Django static file collection"
          fi
          
          # 6. Î∞±ÏóîÎìú ÏÑúÎ≤Ñ Ïû¨ÏãúÏûë (ÏΩîÎìú Î≥ÄÍ≤ΩÏù¥ ÏûàÏùÑ ÎïåÎßå)
          if [ -n "$BACKEND_CODE_CHANGED" ] || [ -n "$BACKEND_DEPS_CHANGED" ]; then
              echo ">>> 6. Backend code changed. Restarting Daphne..."
              pkill -f "^$VENV_DAPHNE" || true
              sleep 2
              
              # ÎßàÏù¥Í∑∏Î†àÏù¥ÏÖò Ïã§Ìñâ
              cd $DJANGO_DIR
              $VENV_PYTHON manage.py migrate --noinput || true
              
              # Daphne Ïû¨ÏãúÏûë
              screen -dmS django $VENV_DAPHNE -b 127.0.0.1 -p 8000 nfc_hospital_system.asgi:application
          else
              echo ">>> 6. Backend unchanged. Keeping current server running."
          fi
          
          # 7. Nginx ÏÑ§Ï†ï (ÌïÑÏöîÌïú Í≤ΩÏö∞Îßå)
          echo ">>> 7. Configuring Nginx..."
          
          # Nginx ÏÑ§Ïπò ÌôïÏù∏ Î∞è Ï°∞Í±¥Î∂Ä ÏÑ§Ïπò
          if ! command -v nginx &> /dev/null; then
              echo "Nginx not found. Installing..."
              sudo apt-get update
              sudo apt-get -y install nginx
          else
              echo "Nginx already installed."
          fi
          
          # Nginx ÏÑ§Ï†ï ÌååÏùº ÏóÖÎç∞Ïù¥Ìä∏ (ÏÑ§Ï†ïÏù¥ Î≥ÄÍ≤ΩÎêòÏóàÍ±∞ÎÇò ÌååÏùºÏù¥ ÏóÜÏùÑ Îïå)
          if [ -n "$NGINX_CONFIG_CHANGED" ] || [ ! -f /etc/nginx/sites-available/nfc-hospital ]; then
              echo "Updating Nginx configuration..."
              
              # Nginx ÏÑ§Ï†ï ÌååÏùº ÏÉùÏÑ± (Ï∫êÏãú Î¨¥Ìö®Ìôî Ìó§Îçî Ï∂îÍ∞Ä)
              sudo tee /etc/nginx/sites-available/nfc-hospital > /dev/null <<EOF
          server {
              listen 80;
              server_name $EC2_HOST;
              
              # ÌîÑÎ°†Ìä∏ÏóîÎìú (React PWA) - Ï∫êÏãú Ï†úÏñ¥ Í∞ïÌôî
              location / {
                  root $FRONTEND_BUILD_PATH;
                  try_files \$uri \$uri/ /index.html;
                  
                  # HTML ÌååÏùºÏùÄ Ï∫êÏãú ÌïòÏßÄ ÏïäÏùå
                  location ~ \.html$ {
                      add_header Cache-Control "no-cache, no-store, must-revalidate";
                      add_header Pragma "no-cache";
                      add_header Expires "0";
                  }
                  
                  # JS, CSS ÌååÏùºÏùÄ ÌååÏùºÎ™ÖÏóê Ìï¥ÏãúÍ∞Ä ÏûàÏúºÎØÄÎ°ú Ïû•Í∏∞Í∞Ñ Ï∫êÏãú
                  location ~ \.(js|css)$ {
                      add_header Cache-Control "public, max-age=31536000, immutable";
                  }
                  
                  # Í∏∞ÌÉÄ Ï†ïÏ†Å ÌååÏùº
                  location ~ \.(jpg|jpeg|png|gif|ico|svg|woff|woff2|ttf|eot)$ {
                      add_header Cache-Control "public, max-age=86400";
                  }
              }
              
              # Î∞±ÏóîÎìú API + ÏõπÏÜåÏºì ÏßÄÏõê
              location ~ ^/(api|admin|ws)/ {
                  proxy_pass http://127.0.0.1:8000;
                  proxy_http_version 1.1;
                  proxy_set_header Upgrade \$http_upgrade;
                  proxy_set_header Connection "upgrade";
                  proxy_set_header Host \$host;
                  proxy_set_header X-Real-IP \$remote_addr;
                  proxy_set_header X-Forwarded-For \$proxy_add_x_forwarded_for;
                  proxy_set_header X-Forwarded-Proto \$scheme;
                  proxy_connect_timeout 300s;
                  proxy_send_timeout 300s;
                  proxy_read_timeout 86400;
                  
                  # API ÏùëÎãµ Ï∫êÏãú Î∞©ÏßÄ
                  add_header Cache-Control "no-cache, no-store, must-revalidate";
                  add_header Pragma "no-cache";
                  add_header Expires "0";
              }
              
              # Django Ï†ïÏ†Å ÌååÏùº
              location /static/ {
                  alias $DJANGO_DIR/staticfiles/;
                  add_header Cache-Control "public, max-age=86400";
              }
          }
          EOF
              
              # Nginx ÏÇ¨Ïù¥Ìä∏ ÌôúÏÑ±Ìôî
              sudo ln -sf /etc/nginx/sites-available/nfc-hospital /etc/nginx/sites-enabled/
              sudo rm -f /etc/nginx/sites-enabled/default
          fi
          
          # 8. ÌîÑÎ°†Ìä∏ÏóîÎìú ÌååÏùº Î≥µÏÇ¨ (ÎπåÎìúÍ∞Ä ÏûàÏóàÏùÑ ÎïåÎßå)
          if [ -n "$FRONTEND_SRC_CHANGED" ] || [ -n "$FRONTEND_DEPS_CHANGED" ]; then
              echo ">>> 8. Copying new frontend build..."
              sudo mkdir -p $FRONTEND_BUILD_PATH
              
              # Í∏∞Ï°¥ ÌååÏùº ÏÇ≠Ï†ú (Ï∫êÏãú Î∞©ÏßÄ)
              sudo rm -rf $FRONTEND_BUILD_PATH/*
              
              # ÏÉà ÌååÏùº Î≥µÏÇ¨
              sudo cp -r $FRONTEND_DIR/dist/* $FRONTEND_BUILD_PATH
              sudo chown -R www-data:www-data $FRONTEND_BUILD_PATH
              sudo chmod -R 755 $FRONTEND_BUILD_PATH
              
              echo "Frontend files updated with timestamp"
          else
              echo ">>> 8. Skipping frontend file copy (no build changes)"
          fi
          
          # 9. Nginx Ïû¨ÏãúÏûë (ÏÑ§Ï†ïÏù¥ÎÇò ÌååÏùºÏù¥ Î≥ÄÍ≤ΩÎêòÏóàÏùÑ Îïå)
          if [ -n "$NGINX_CONFIG_CHANGED" ] || [ -n "$FRONTEND_SRC_CHANGED" ] || [ -n "$FRONTEND_DEPS_CHANGED" ]; then
              echo ">>> 9. Restarting Nginx..."
              sudo nginx -t
              sudo systemctl reload nginx
              sudo systemctl enable nginx
          else
              echo ">>> 9. Nginx configuration unchanged."
          fi
          
          # 10. Ï∫êÏãú Î¨¥Ìö®Ìôî ÏûëÏóÖ
          echo ">>> 10. Invalidating caches..."
          
          # CloudFront Ï∫êÏãú Î¨¥Ìö®Ìôî (ÏûàÎäî Í≤ΩÏö∞)
          # aws cloudfront create-invalidation --distribution-id YOUR_DISTRIBUTION_ID --paths "/*" || true
          
          # Redis Ï∫êÏãú ÌÅ¥Î¶¨Ïñ¥ (ÏûàÎäî Í≤ΩÏö∞)
          if command -v redis-cli &> /dev/null; then
              redis-cli FLUSHDB || true
          fi
          
          # 11. ÏµúÏ¢Ö ÏÉÅÌÉú Í≤ÄÏ¶ù
          echo ">>> 11. Verifying deployment..."
          sleep 5
          
          # Î∞±ÏóîÎìú ÏÑúÎ≤Ñ ÌôïÏù∏
          if [ -n "$BACKEND_CODE_CHANGED" ] || [ -n "$BACKEND_DEPS_CHANGED" ]; then
              if ! screen -list | grep -q "django"; then
                  echo "‚ùå Backend server failed to start. Check server logs."
                  exit 1
              fi
          fi
          
          # ÏõπÏÇ¨Ïù¥Ìä∏ ÏùëÎãµ ÌôïÏù∏
          if curl -f http://localhost/ > /dev/null 2>&1; then
              echo "‚úÖ Success: Deployment completed!"
              echo "üåê Frontend: http://$EC2_HOST/"
              echo "üîß Backend API: http://$EC2_HOST/api/"
              echo "‚öôÔ∏è  Admin: http://$EC2_HOST/admin/"
              echo "üîå WebSocket: http://$EC2_HOST/ws/"
              echo ""
              echo "üìä Deployment Summary:"
              echo "- Backend deps updated: $([ -n "$BACKEND_DEPS_CHANGED" ] && echo "Yes" || echo "No")"
              echo "- Frontend deps updated: $([ -n "$FRONTEND_DEPS_CHANGED" ] && echo "Yes" || echo "No")"
              echo "- Frontend rebuilt: $([ -n "$FRONTEND_SRC_CHANGED" ] && echo "Yes" || echo "No")"
              echo "- Backend restarted: $([ -n "$BACKEND_CODE_CHANGED" ] && echo "Yes" || echo "No")"
              echo "- Nginx updated: $([ -n "$NGINX_CONFIG_CHANGED" ] && echo "Yes" || echo "No")"
          else
              echo "‚ùå ERROR: Website is not responding."
              exit 1
          fi