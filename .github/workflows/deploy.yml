name: Deploy Full Stack to EC2

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Deploy Full Stack to EC2
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.EC2_HOST }}
        username: ${{ secrets.EC2_USER }}
        key: ${{ secrets.EC2_SSH_KEY }}
        script: |
          # --- ì™„ì „í•œ í’€ìŠ¤íƒ ìë™ ë°°í¬ ìŠ¤í¬ë¦½íŠ¸ ---
          
          # ìŠ¤í¬ë¦½íŠ¸ ì•ˆì •ì„± ê°•í™” (ëª…ë ¹ì–´ ì‹¤íŒ¨ ì‹œ ì¦‰ì‹œ ì¤‘ë‹¨)
          set -e
          
          # ì£¼ìš” ê²½ë¡œ ë³€ìˆ˜ ì •ì˜ (ì§ì ‘ ê°’ ì‚¬ìš©)
          PROJECT_DIR="$HOME/nfc-hospital"
          BACKEND_DIR="$PROJECT_DIR/backend"
          FRONTEND_DIR="$PROJECT_DIR/frontend-pwa"
          VENV_DAPHNE="$BACKEND_DIR/venv/bin/daphne"
          VENV_PIP="$BACKEND_DIR/venv/bin/pip"
          DJANGO_DIR="$BACKEND_DIR/nfc_hospital_system"
          FRONTEND_BUILD_PATH="/var/www/nfc-hospital"
          EC2_HOST="15.164.94.194"
          
          echo "âœ… Using EC2_HOST: $EC2_HOST"
          echo "âœ… Using FRONTEND_BUILD_PATH: $FRONTEND_BUILD_PATH"
          
          # 1. ì½”ë“œ ì—…ë°ì´íŠ¸, ì˜ì¡´ì„± ì„¤ì¹˜, í”„ë¡ íŠ¸ì—”ë“œ ë¹Œë“œ
          echo ">>> 1. Pulling, Installing, and Building..."
          cd $PROJECT_DIR
          git pull origin main
          $VENV_PIP install -r $DJANGO_DIR/requirements.txt
          cd $FRONTEND_DIR
          npm install
          npm run build
          
          # 2. ì´ì „ ë°±ì—”ë“œ ì„œë²„(Daphne) ì¢…ë£Œ
          echo ">>> 2. Safely stopping the old backend server..."
          pkill -f "^$VENV_DAPHNE" || true
          sleep 2
          
          # 3. Nginx ì„¤ì • ë° í”„ë¡ íŠ¸ì—”ë“œ íŒŒì¼ ë³µì‚¬/ê¶Œí•œ ì„¤ì •
          echo ">>> 3. Setting up Nginx and copying files..."
          sudo apt-get update
          sudo apt-get -y install nginx
          
          # Nginx ì„¤ì • íŒŒì¼ ìë™ ìƒì„± (ì›¹ì†Œì¼“ ì§€ì› í¬í•¨)
          sudo tee /etc/nginx/sites-available/nfc-hospital > /dev/null <<EOF
          server {
              listen 80;
              server_name $EC2_HOST;
              
              # í”„ë¡ íŠ¸ì—”ë“œ (React PWA)
              location / {
                  root $FRONTEND_BUILD_PATH;
                  try_files \$uri \$uri/ /index.html;
                  add_header Cache-Control "no-cache, no-store, must-revalidate";
              }
              
              # ë°±ì—”ë“œ API + ì›¹ì†Œì¼“ ì§€ì›
              location ~ ^/(api|admin|ws)/ {
                  proxy_pass http://127.0.0.1:8000;
                  proxy_http_version 1.1;
                  proxy_set_header Upgrade \$http_upgrade;
                  proxy_set_header Connection "upgrade";
                  proxy_set_header Host \$host;
                  proxy_set_header X-Real-IP \$remote_addr;
                  proxy_set_header X-Forwarded-For \$proxy_add_x_forwarded_for;
                  proxy_set_header X-Forwarded-Proto \$scheme;
                  proxy_read_timeout 86400;
              }
          }
          EOF
          
          # í”„ë¡ íŠ¸ì—”ë“œ ë¹Œë“œ ê²°ê³¼ë¬¼ì„ ì›¹ ì„œë²„ ê²½ë¡œë¡œ ë³µì‚¬ ë° ê¶Œí•œ ì„¤ì •
          echo "Creating directory: $FRONTEND_BUILD_PATH"
          sudo mkdir -p $FRONTEND_BUILD_PATH
          echo "Copying files from $FRONTEND_DIR/dist/* to $FRONTEND_BUILD_PATH"
          sudo cp -r $FRONTEND_DIR/dist/* $FRONTEND_BUILD_PATH
          sudo chown -R www-data:www-data $FRONTEND_BUILD_PATH
          sudo chmod -R 755 $FRONTEND_BUILD_PATH
          
          # Nginx ì‚¬ì´íŠ¸ í™œì„±í™” ë° ì¬ì‹œì‘
          sudo ln -sf /etc/nginx/sites-available/nfc-hospital /etc/nginx/sites-enabled/
          sudo rm -f /etc/nginx/sites-enabled/default
          echo ">>> Testing Nginx configuration..."
          sudo nginx -t
          echo ">>> Restarting Nginx..."
          sudo systemctl restart nginx
          sudo systemctl enable nginx
          
          # 4. ìƒˆ ë°±ì—”ë“œ ì„œë²„ë¥¼ Daphneë¡œ ì‹œì‘
          echo ">>> 4. Starting backend server with Daphne..."
          cd $DJANGO_DIR
          screen -dmS django $VENV_DAPHNE -b 127.0.0.1 -p 8000 nfc_hospital_system.asgi:application
          
          # 5. ìµœì¢… ìƒíƒœ ê²€ì¦
          echo ">>> 5. Verifying deployment..."
          sleep 5
          
          if ! screen -list | grep -q "django"; then
            echo "âŒ Backend server failed to start. Check server logs."
            exit 1
          fi
          
          if curl -f http://localhost/ > /dev/null 2>&1; then
              echo "âœ… Success: Full stack deployment completed!"
              echo "ğŸŒ Frontend: http://$EC2_HOST/"
              echo "ğŸ”§ Backend API: http://$EC2_HOST/api/"
              echo "âš™ï¸  Admin: http://$EC2_HOST/admin/"
              echo "ğŸ”Œ WebSocket: http://$EC2_HOST/ws/"
          else
              echo "âŒ ERROR: Nginx/Frontend is not responding."
              exit 1
          fi