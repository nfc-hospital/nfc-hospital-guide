# EMR ì˜ˆì¸¡ ì‹œìŠ¤í…œ í†µí•© - ì‹¤ì „ êµ¬í˜„ ê³„íšì„œ
# ì‘ì„±ì¼: 2025-09-09
# ê²€ì¦: database.md, api.md ì™„ë²½ í˜¸í™˜

================================================================================
## ğŸ“Œ í•µì‹¬ ìš”ì•½
================================================================================

ë³¸ ê³„íšì„œëŠ” ê¸°ì¡´ í”„ë¡œì íŠ¸ì˜ database.mdì™€ api.mdë¥¼ 100% ì¤€ìˆ˜í•˜ë©°,
ì¦‰ì‹œ êµ¬í˜„ ê°€ëŠ¥í•œ EMR ì˜ˆì¸¡ ì‹œìŠ¤í…œ í†µí•© ë°©ì•ˆì„ ì œì‹œí•©ë‹ˆë‹¤.

- êµ¬í˜„ ê¸°ê°„: 5ì¼
- í™œìš© í…Œì´ë¸”: emr_sync_status, queues, patient_states, queue_status_logs
- ì‹ ê·œ API: /api/v1/analytics/predictions/
- ê¸°ì¡´ ì»´í¬ë„ŒíŠ¸: LSTMPrediction.jsx ì¬ì‚¬ìš©

================================================================================
## ğŸ¯ ë‹¨ê³„ 1: ê°€ìƒ EMR ë°ì´í„° ìƒì„±ê¸° (1ì¼ì°¨)
================================================================================

### 1.1 ë””ë ‰í† ë¦¬ êµ¬ì¡° ìƒì„±

backend/nfc_hospital_system/integrations/management/commands/ ìƒì„±
(ê¸°ì¡´ authentication/management/commands/create_test_data.py ì°¸ê³ )

### 1.2 generate_emr_data.py êµ¬í˜„

```python
# ê¸°ì¡´ í…Œì´ë¸” í™œìš© (database.md ì¤€ìˆ˜)
# - emr_sync_status: ê°€ìƒ EMR ë™ê¸°í™” ë°ì´í„°
# - queues: ëŒ€ê¸°ì—´ ë°ì´í„° (created_at í•„ë“œ ì‚¬ìš©)
# - patient_states: 9ë‹¨ê³„ í™˜ì ìƒíƒœ
# - queue_status_logs: ìƒíƒœ ë³€ê²½ ì´ë ¥

class Command(BaseCommand):
    def add_arguments(self, parser):
        parser.add_argument('--months', type=int, default=3)
        parser.add_argument('--daily-patients', type=int, default=250)
    
    def handle(self, *args, **options):
        # 1. ë³‘ì› ìš´ì˜ íŒ¨í„´ (ì‹¤ì œ ë³‘ì› ë°ì´í„° ê¸°ë°˜)
        WEEKDAY_FACTOR = {
            0: 1.3,  # ì›”ìš”ì¼
            1: 1.0,  # í™”ìš”ì¼
            2: 1.0,  # ìˆ˜ìš”ì¼
            3: 1.0,  # ëª©ìš”ì¼
            4: 0.7,  # ê¸ˆìš”ì¼
        }
        
        HOURLY_FACTOR = {
            9: 1.5,   # ì˜¤ì „ í”¼í¬
            10: 1.5,
            11: 1.3,
            12: 0.6,  # ì ì‹¬ì‹œê°„
            14: 1.2,  # ì˜¤í›„ í”¼í¬
            15: 1.2,
        }
        
        # 2. ë¶€ì„œë³„ ë¶„í¬ (ê¸°ì¡´ Exam í…Œì´ë¸” department í•„ë“œ í™œìš©)
        DEPARTMENTS = [
            'ë‚´ê³¼',           # 35%
            'ì •í˜•ì™¸ê³¼',       # 20%
            'ì˜ìƒì˜í•™ê³¼',     # 15%
            'ì§„ë‹¨ê²€ì‚¬ì˜í•™ê³¼', # 15%
        ]
        
        # 3. í™˜ì ìƒíƒœ ì „ì´ (9ë‹¨ê³„)
        STATE_TRANSITIONS = [
            ('UNREGISTERED', 0),
            ('ARRIVED', 5),
            ('REGISTERED', 10),
            ('WAITING', 30),      # í‰ê·  30ë¶„ ëŒ€ê¸°
            ('CALLED', 5),
            ('ONGOING', 15),      # í‰ê·  15ë¶„ ê²€ì‚¬
            ('COMPLETED', 5),
            ('PAYMENT', 10),
            ('FINISHED', 0)
        ]
        
        # 4. ë°ì´í„° ìƒì„± (3ê°œì›”, ì•½ 20,000ê±´)
        self.generate_patient_journeys(options['months'], options['daily-patients'])
```

### 1.3 ì‹¤í–‰ ëª…ë ¹

```bash
cd backend/nfc_hospital_system
python manage.py generate_emr_data --months 3 --daily-patients 250
```

================================================================================
## ğŸ¤– ë‹¨ê³„ 2: LSTM ëª¨ë¸ í•™ìŠµ (2ì¼ì°¨)
================================================================================

### 2.1 í•™ìŠµ ë°ì´í„° ì¶”ì¶œ (ê¸°ì¡´ í…Œì´ë¸” í™œìš©)

```sql
-- database.mdì˜ queues í…Œì´ë¸” êµ¬ì¡° í™œìš©
SELECT 
    DATE(q.created_at) as date,           -- joined_atì´ ì•„ë‹Œ created_at ì‚¬ìš©
    HOUR(q.created_at) as hour,
    DAYOFWEEK(q.created_at) as weekday,
    e.department,
    COUNT(*) as patient_count,
    AVG(q.estimated_wait_time) as avg_wait_time,
    COUNT(CASE WHEN q.state = 'waiting' THEN 1 END) as waiting_count
FROM queues q
JOIN exams e ON q.exam_id = e.exam_id
WHERE q.created_at >= DATE_SUB(NOW(), INTERVAL 3 MONTH)
GROUP BY DATE(q.created_at), HOUR(q.created_at), e.department
```

### 2.2 LSTM ëª¨ë¸ êµ¬ì¡° (ê°„ë‹¨í•˜ê³  íš¨ìœ¨ì )

```python
# ì…ë ¥: ìµœê·¼ 1ì‹œê°„ ë°ì´í„° (12ê°œ íƒ€ì„ìŠ¤í…, 5ë¶„ ë‹¨ìœ„)
# íŠ¹ì§•: [ëŒ€ê¸°ì¸ì›, í‰ê· ëŒ€ê¸°ì‹œê°„, ì‹œê°„ëŒ€, ìš”ì¼]
# ì¶œë ¥: [ì˜ˆìƒëŒ€ê¸°ì‹œê°„, í˜¼ì¡ë„]

model = Sequential([
    LSTM(32, input_shape=(12, 4)),
    Dropout(0.2),
    Dense(16, activation='relu'),
    Dense(2)  # [ëŒ€ê¸°ì‹œê°„, í˜¼ì¡ë„]
])
```

### 2.3 Google Colabì—ì„œ í•™ìŠµ

1. prepare_training_data.pyë¡œ CSV ì¶”ì¶œ
2. Colabì— ì—…ë¡œë“œ
3. ëª¨ë¸ í•™ìŠµ (ì•½ 30ë¶„)
4. TFLite ë³€í™˜ (1MB ì´í•˜)
5. hospital_lstm.tflite ë‹¤ìš´ë¡œë“œ

================================================================================
## ğŸ”Œ ë‹¨ê³„ 3: Django ë°±ì—”ë“œ í†µí•© (3ì¼ì°¨)
================================================================================

### 3.1 ëª¨ë¸ ë¡œë” (ì‹±ê¸€í†¤ íŒ¨í„´)

backend/nfc_hospital_system/integrations/services/model_loader.py

```python
import tensorflow as tf
from django.conf import settings
import os

class LSTMPredictor:
    _instance = None
    
    def __new__(cls):
        if cls._instance is None:
            cls._instance = super().__new__(cls)
            cls._instance.initialize()
        return cls._instance
    
    def initialize(self):
        model_path = os.path.join(settings.BASE_DIR, 'ml_models', 'hospital_lstm.tflite')
        self.interpreter = tf.lite.Interpreter(model_path=model_path)
        self.interpreter.allocate_tensors()
    
    def predict(self, department, hour):
        # ê°„ë‹¨í•œ ì˜ˆì¸¡ ë¡œì§
        input_data = self.prepare_input(department, hour)
        self.interpreter.set_tensor(self.input_details[0]['index'], input_data)
        self.interpreter.invoke()
        output = self.interpreter.get_tensor(self.output_details[0]['index'])
        
        return {
            'predicted_wait_time': int(output[0][0]),
            'congestion_level': float(output[0][1])
        }

predictor = LSTMPredictor()  # ì‹±ê¸€í†¤ ì¸ìŠ¤í„´ìŠ¤
```

### 3.2 ì˜ˆì¸¡ ì„œë¹„ìŠ¤ (Redis ìºì‹±)

backend/nfc_hospital_system/integrations/services/prediction_service.py

```python
from django.core.cache import cache
from p_queue.models import Queue
from .model_loader import predictor

class PredictionService:
    @staticmethod
    def get_predictions(timeframe='30min'):
        # ìºì‹œ í‚¤ (5ë¶„ ë‹¨ìœ„)
        cache_key = f"predictions:{timeframe}:{timezone.now().strftime('%Y%m%d%H%M')[:12]}"
        cached = cache.get(cache_key)
        
        if cached:
            return cached
        
        # ê° ë¶€ì„œë³„ ì˜ˆì¸¡
        departments = ['ë‚´ê³¼', 'ì •í˜•ì™¸ê³¼', 'ì˜ìƒì˜í•™ê³¼', 'ì§„ë‹¨ê²€ì‚¬ì˜í•™ê³¼']
        predictions = {}
        
        for dept in departments:
            # í˜„ì¬ ìƒíƒœ (database.mdì˜ queues í…Œì´ë¸”)
            current = Queue.objects.filter(
                exam__department=dept,
                state__in=['waiting', 'called']
            ).aggregate(
                wait_time=Avg('estimated_wait_time'),
                count=Count('queue_id')
            )
            
            # LSTM ì˜ˆì¸¡
            future = predictor.predict(dept, timezone.now().hour)
            
            predictions[dept] = {
                'current_wait': current['wait_time'] or 0,
                'predicted_wait': future['predicted_wait_time'],
                'congestion': future['congestion_level'],
                'trend': 'up' if future['predicted_wait_time'] > (current['wait_time'] or 0) else 'down'
            }
        
        cache.set(cache_key, predictions, 300)  # 5ë¶„ ìºì‹±
        return predictions
```

### 3.3 API ì—”ë“œí¬ì¸íŠ¸ ì¶”ê°€ (api.md ì¤€ìˆ˜)

backend/nfc_hospital_system/analytics/views.pyì— ì¶”ê°€:

```python
@api_view(['GET'])
@permission_classes([permissions.IsAuthenticated])
def predictions(request):
    """
    LSTM ì˜ˆì¸¡ API - GET /api/v1/analytics/predictions/
    api.mdì˜ í‘œì¤€ ì‘ë‹µ í˜•ì‹ ì¤€ìˆ˜
    """
    
    # ê¶Œí•œ í™•ì¸ (Dept-Admin ì´ìƒ)
    if request.user.role not in ['super', 'dept']:
        return APIResponse.error(
            message="ë¶€ì„œ ê´€ë¦¬ì ì´ìƒì˜ ê¶Œí•œì´ í•„ìš”í•©ë‹ˆë‹¤.",
            code="FORBIDDEN",
            status_code=status.HTTP_403_FORBIDDEN
        )
    
    timeframe = request.GET.get('timeframe', '30min')
    data = PredictionService.get_predictions(timeframe)
    
    # api.md í‘œì¤€ ì‘ë‹µ í˜•ì‹
    return APIResponse.success(
        data={
            'predictions': data,
            'timeframe': timeframe,
            'model_version': '1.0',
            'timestamp': timezone.now().isoformat()
        },
        message="ì˜ˆì¸¡ ë°ì´í„°ë¥¼ ì¡°íšŒí–ˆìŠµë‹ˆë‹¤.",
        status_code=status.HTTP_200_OK
    )
```

### 3.4 URL ë¼ìš°íŒ… ì¶”ê°€

backend/nfc_hospital_system/analytics/urls.py:

```python
urlpatterns = [
    # ê¸°ì¡´ ì—”ë“œí¬ì¸íŠ¸ë“¤...
    path('predictions/', views.predictions, name='lstm-predictions'),
]
```

================================================================================
## ğŸ“± ë‹¨ê³„ 4: í”„ë¡ íŠ¸ì—”ë“œ ì—°ë™ (4ì¼ì°¨)  
================================================================================

### 4.1 ê¸°ì¡´ LSTMPrediction.jsx ìˆ˜ì •

frontend-pwa/src/components/admin/dashboard/LSTMPrediction.jsx:

```javascript
// ê°€ì§œ ë°ì´í„°ë¥¼ ì‹¤ì œ APIë¡œ êµì²´
import { useAPI } from '../../../hooks/useAPI';

const LSTMPrediction = () => {
    const [selectedTimeframe, setSelectedTimeframe] = useState('30min');
    
    // API í˜¸ì¶œ
    const { data, loading, error } = useAPI(
        `/api/v1/analytics/predictions/?timeframe=${selectedTimeframe}`
    );
    
    useEffect(() => {
        if (data?.predictions) {
            // ë°ì´í„° í˜•ì‹ ë³€í™˜
            const formatted = Object.entries(data.predictions).map(([dept, pred]) => ({
                name: dept,
                current: pred.current_wait,
                predicted: pred.predicted_wait,
                congestion: pred.congestion * 100,
                trend: pred.trend,
                color: DEPT_COLORS[dept] || '#3b82f6'
            }));
            
            setDepartmentPredictions(formatted);
        }
    }, [data]);
    
    // 30ì´ˆë§ˆë‹¤ ìë™ ê°±ì‹ 
    useEffect(() => {
        const interval = setInterval(() => {
            refetch();
        }, 30000);
        return () => clearInterval(interval);
    }, []);
    
    // ë‚˜ë¨¸ì§€ UIëŠ” ê·¸ëŒ€ë¡œ ìœ ì§€
};
```

### 4.2 WebSocket ì‹¤ì‹œê°„ ì—…ë°ì´íŠ¸ (ì„ íƒì‚¬í•­)

ê¸°ì¡´ admin_dashboard/consumers.py í™œìš© ê°€ëŠ¥

================================================================================
## ğŸ” ë‹¨ê³„ 5: í…ŒìŠ¤íŠ¸ ë° ê²€ì¦ (5ì¼ì°¨)
================================================================================

### 5.1 ë‹¨ìœ„ í…ŒìŠ¤íŠ¸

```python
# backend/nfc_hospital_system/integrations/tests.py

class PredictionTestCase(TestCase):
    def test_model_loading(self):
        """ëª¨ë¸ ë¡œë”© í…ŒìŠ¤íŠ¸"""
        from integrations.services.model_loader import predictor
        self.assertIsNotNone(predictor.interpreter)
    
    def test_prediction_api(self):
        """API ì—”ë“œí¬ì¸íŠ¸ í…ŒìŠ¤íŠ¸"""
        response = self.client.get('/api/v1/analytics/predictions/')
        self.assertEqual(response.status_code, 200)
        self.assertTrue(response.data['success'])
    
    def test_cache_hit(self):
        """ìºì‹œ ë™ì‘ í…ŒìŠ¤íŠ¸"""
        # ì²« ë²ˆì§¸ í˜¸ì¶œ (ìºì‹œ ë¯¸ìŠ¤)
        # ë‘ ë²ˆì§¸ í˜¸ì¶œ (ìºì‹œ íˆíŠ¸)
        # ì‘ë‹µ ì‹œê°„ ë¹„êµ
```

### 5.2 í†µí•© í…ŒìŠ¤íŠ¸

```bash
# 1. ê°€ìƒ ë°ì´í„° ìƒì„±
python manage.py generate_emr_data --months 1 --daily-patients 100

# 2. API í…ŒìŠ¤íŠ¸
curl -H "Authorization: Bearer $TOKEN" \
     http://localhost:8000/api/v1/analytics/predictions/

# 3. í”„ë¡ íŠ¸ì—”ë“œ í™•ì¸
pnpm dev:frontend
# http://localhost:5174/admin/dashboard ì ‘ì†
```

================================================================================
## ğŸ“Š ì„±ëŠ¥ ëª©í‘œ ë° ê²€ì¦ ì§€í‘œ
================================================================================

### í•„ìˆ˜ ë‹¬ì„± ëª©í‘œ
- âœ… ì˜ˆì¸¡ ì •í™•ë„: 70% ì´ìƒ (MAE < 10ë¶„)
- âœ… API ì‘ë‹µì‹œê°„: 200ms ì´í•˜
- âœ… ìºì‹œ íˆíŠ¸ìœ¨: 80% ì´ìƒ
- âœ… ëª¨ë¸ í¬ê¸°: 1MB ì´í•˜
- âœ… ë©”ëª¨ë¦¬ ì‚¬ìš©: 100MB ì´í•˜

### ê²€ì¦ ë°©ë²•
1. PredictionLog í…Œì´ë¸”ì— ì˜ˆì¸¡ ê¸°ë¡
2. 30ë¶„ í›„ ì‹¤ì œê°’ê³¼ ë¹„êµ
3. ì£¼ê°„ ì •í™•ë„ ë¦¬í¬íŠ¸ ìƒì„±

================================================================================
## ğŸš€ ì‹¤í–‰ ì²´í¬ë¦¬ìŠ¤íŠ¸
================================================================================

â–¡ Day 1: ê°€ìƒ ë°ì´í„° ìƒì„±
  â–¡ management/commands ë””ë ‰í† ë¦¬ ìƒì„±
  â–¡ generate_emr_data.py ì‘ì„±
  â–¡ 3ê°œì›”ì¹˜ ë°ì´í„° ìƒì„± (20,000ê±´)
  â–¡ ë°ì´í„° ê²€ì¦

â–¡ Day 2: ëª¨ë¸ í•™ìŠµ
  â–¡ í•™ìŠµ ë°ì´í„° ì¶”ì¶œ (CSV)
  â–¡ Google Colabì—ì„œ LSTM í•™ìŠµ
  â–¡ TFLite ë³€í™˜
  â–¡ ëª¨ë¸ íŒŒì¼ ì €ì¥ (ml_models/)

â–¡ Day 3: ë°±ì—”ë“œ í†µí•©
  â–¡ model_loader.py êµ¬í˜„
  â–¡ prediction_service.py êµ¬í˜„
  â–¡ analytics/views.pyì— API ì¶”ê°€
  â–¡ Redis ìºì‹± ì„¤ì •

â–¡ Day 4: í”„ë¡ íŠ¸ì—”ë“œ ì—°ë™
  â–¡ LSTMPrediction.jsx ìˆ˜ì •
  â–¡ API ì—°ë™ í…ŒìŠ¤íŠ¸
  â–¡ ìë™ ê°±ì‹  êµ¬í˜„
  â–¡ UI/UX ìµœì í™”

â–¡ Day 5: í…ŒìŠ¤íŠ¸ ë° ë°°í¬
  â–¡ ë‹¨ìœ„ í…ŒìŠ¤íŠ¸ ì‘ì„±
  â–¡ í†µí•© í…ŒìŠ¤íŠ¸ ì‹¤í–‰
  â–¡ ì„±ëŠ¥ ì¸¡ì •
  â–¡ ë¬¸ì„œí™”

================================================================================
## ğŸ“¦ í•„ìš” íŒ¨í‚¤ì§€
================================================================================

# requirements.txtì— ì¶”ê°€
tensorflow==2.15.0      # TFLite ì§€ì›
pandas==2.0.3          # ë°ì´í„° ì²˜ë¦¬
scikit-learn==1.3.2    # ë°ì´í„° ì „ì²˜ë¦¬
redis==5.0.1           # ìºì‹±

# ì„¤ì¹˜ ëª…ë ¹
pip install -r requirements.txt

================================================================================
## âš ï¸ ì£¼ì˜ì‚¬í•­
================================================================================

1. database.md ì¤€ìˆ˜
   - queues í…Œì´ë¸”ì˜ created_at í•„ë“œ ì‚¬ìš© (joined_at X)
   - patient_statesì˜ current_stateë¡œ 9ë‹¨ê³„ ìƒíƒœ ê´€ë¦¬
   - emr_sync_statusë¥¼ ê°€ìƒ EMR ë°ì´í„° ì €ì¥ìš©ìœ¼ë¡œ í™œìš©

2. api.md ì¤€ìˆ˜
   - /api/v1/analytics/predictions/ ê²½ë¡œ ì‚¬ìš©
   - í‘œì¤€ ì‘ë‹µ í˜•ì‹ (success, data, message)
   - ê¶Œí•œ ì²´ê³„ (Dept-Admin ì´ìƒ)

3. ê¸°ì¡´ ì½”ë“œ ì¬ì‚¬ìš©
   - create_test_data.py ì°¸ê³ 
   - LSTMPrediction.jsx ì¬ì‚¬ìš©
   - analytics views.py í™•ì¥

================================================================================
## ğŸ“ ì˜ˆìƒ ê²°ê³¼ë¬¼
================================================================================

1. ê°€ìƒ EMR ë°ì´í„° 20,000ê±´
2. í•™ìŠµëœ LSTM ëª¨ë¸ (TFLite, < 1MB)
3. ì˜ˆì¸¡ API ì—”ë“œí¬ì¸íŠ¸ (/api/v1/analytics/predictions/)
4. ì‹¤ì‹œê°„ ëŒ€ì‹œë³´ë“œ (30ì´ˆ ìë™ ê°±ì‹ )
5. ì˜ˆì¸¡ ì •í™•ë„ 70% ì´ìƒ

================================================================================
## ğŸ¯ ì„±ê³µ ê¸°ì¤€
================================================================================

âœ… ê¸°ì¡´ database.md í…Œì´ë¸” êµ¬ì¡° 100% í™œìš©
âœ… api.md í‘œì¤€ ì¤€ìˆ˜
âœ… 5ì¼ ë‚´ êµ¬í˜„ ì™„ë£Œ
âœ… ì‹¤ì œ ìš´ì˜ ê°€ëŠ¥í•œ í’ˆì§ˆ
âœ… ë³µì¡í•˜ì§€ ì•Šê³  ìœ ì§€ë³´ìˆ˜ ìš©ì´

================================================================================

ì‘ì„±: 2025-09-09
ê²€ì¦: database.md, api.md ì™„ë²½ í˜¸í™˜ í™•ì¸
ìƒíƒœ: ì¦‰ì‹œ êµ¬í˜„ ê°€ëŠ¥