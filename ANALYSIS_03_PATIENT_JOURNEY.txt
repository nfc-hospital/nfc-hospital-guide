================================================================================
ê¸°ëŠ¥ë³„ ìƒì„¸ ë¶„ì„ ë³´ê³ ì„œ #3: í™˜ì ì—¬ì • ìƒíƒœ ê´€ë¦¬
================================================================================
ì‘ì„±ì¼: 2025ë…„ 1ì›” 9ì¼
ë¶„ì„ ë²”ìœ„: ë°±ì—”ë“œ + í”„ë¡ íŠ¸ì—”ë“œ í†µí•©
í˜„ì¬ ì™„ì„±ë„: 90%
================================================================================

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸ“ ê´€ë ¨ íŒŒì¼ êµ¬ì¡°
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

ã€ë°±ì—”ë“œã€‘
backend/nfc_hospital_system/
â”œâ”€â”€ p_queue/
â”‚   â”œâ”€â”€ services.py              # PatientJourneyService í•µì‹¬ ë¡œì§
â”‚   â”œâ”€â”€ models.py                # Queue, PatientState, StateTransition
â”‚   â”œâ”€â”€ views.py                 # ìƒíƒœ ê´€ë¦¬ API
â”‚   â”œâ”€â”€ signals.py               # ìƒíƒœ ë³€ê²½ ì‹œê·¸ë„
â”‚   â””â”€â”€ urls.py                  # API ì—”ë“œí¬ì¸íŠ¸
â””â”€â”€ common/
    â””â”€â”€ state_definitions.py     # ìƒíƒœ ì •ì˜ ë° ì „ì´ ê·œì¹™

ã€í”„ë¡ íŠ¸ì—”ë“œã€‘
frontend-pwa/src/
â”œâ”€â”€ store/journeyStore.js        # Zustand ìƒíƒœ ê´€ë¦¬
â”œâ”€â”€ hooks/usePatientJourney.js   # WebSocket ì—°ë™ í›…
â”œâ”€â”€ components/
â”‚   â””â”€â”€ JourneyContainer.jsx     # ìƒíƒœë³„ í™”ë©´ ë¼ìš°íŒ…
â”œâ”€â”€ api/patientJourneyService.js # API í˜¸ì¶œ
â””â”€â”€ pages/                       # ìƒíƒœë³„ í™”ë©´ ì»´í¬ë„ŒíŠ¸
    â”œâ”€â”€ UnregisteredScreen.jsx
    â”œâ”€â”€ ArrivedScreen.jsx
    â”œâ”€â”€ RegisteredScreen.jsx
    â”œâ”€â”€ WaitingScreen.jsx
    â”œâ”€â”€ PaymentScreen.jsx
    â””â”€â”€ FinishedScreen.jsx

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸ” í˜„ì¬ êµ¬í˜„ ìƒíƒœ ë¶„ì„
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

================================================================================
1. ë°±ì—”ë“œ ìƒíƒœ ê´€ë¦¬ ì‹œìŠ¤í…œ
================================================================================

ã€âœ… ì˜ êµ¬í˜„ëœ ë¶€ë¶„ã€‘

1.1 PatientJourneyService í•µì‹¬ ë¡œì§
```python
class PatientJourneyService:
    @transaction.atomic
    def perform_action(self, action_type: str, payload: Dict):
        # 1. í˜„ì¬ ìƒíƒœ ì¡°íšŒ
        patient_state = self._get_or_create_patient_state()
        current_state = PatientJourneyState(patient_state.current_state)
        
        # 2. ì•¡ì…˜ íƒ€ì… ê²€ì¦
        if action_type in [a.value for a in PatientAction]:
            action = PatientAction(action_type)
        elif action_type in [a.value for a in StaffAction]:
            action = StaffAction(action_type)
        
        # 3. ìƒíƒœ ì „ì´ ê°€ëŠ¥ ì—¬ë¶€ í™•ì¸
        if action not in STATE_TRANSITIONS[current_state]:
            raise InvalidActionError()
        
        # 4. ìƒˆë¡œìš´ ìƒíƒœë¡œ ë³€ê²½
        new_state = STATE_TRANSITIONS[current_state][action]
        patient_state.current_state = new_state.value
        patient_state.save()
        
        # 5. Queue ìƒíƒœ ë™ê¸°í™”
        self._sync_queue_state(new_state, payload)
        
        # 6. WebSocket ì•Œë¦¼
        self._send_state_update(new_state.value, action_type)
```
- íŠ¸ëœì­ì…˜ìœ¼ë¡œ ë°ì´í„° ì¼ê´€ì„± ë³´ì¥ âœ“
- ëª…í™•í•œ ì•¡ì…˜ ê¸°ë°˜ ìƒíƒœ ì „ì´ âœ“
- ìë™ Queue ë™ê¸°í™” âœ“
- ì‹¤ì‹œê°„ ì•Œë¦¼ ì§€ì› âœ“

1.2 9ë‹¨ê³„ í™˜ì ì—¬ì • ìƒíƒœ
```python
class PatientJourneyState(Enum):
    UNREGISTERED = "UNREGISTERED"  # ë³‘ì› ë„ì°© ì „
    ARRIVED = "ARRIVED"            # ë³‘ì› ë„ì°©, ë¯¸ì ‘ìˆ˜
    REGISTERED = "REGISTERED"      # ì ‘ìˆ˜ ì™„ë£Œ
    WAITING = "WAITING"            # ëŒ€ê¸° ì¤‘
    CALLED = "CALLED"              # í˜¸ì¶œë¨
    IN_PROGRESS = "IN_PROGRESS"    # ê²€ì‚¬/ì§„ë£Œ ì¤‘
    COMPLETED = "COMPLETED"        # ê²€ì‚¬/ì§„ë£Œ ì™„ë£Œ
    PAYMENT = "PAYMENT"            # ìˆ˜ë‚© ëŒ€ê¸°/ì™„ë£Œ
    FINISHED = "FINISHED"          # ëª¨ë“  ê³¼ì • ì™„ë£Œ
```
- ë³‘ì› í”„ë¡œì„¸ìŠ¤ ì „ì²´ ì»¤ë²„ âœ“
- EMR ìƒíƒœì™€ ë§¤í•‘ ê°€ëŠ¥ âœ“
- ëª…í™•í•œ ìƒíƒœ êµ¬ë¶„ âœ“

1.3 ìƒíƒœ ì „ì´ ê·œì¹™
```python
STATE_TRANSITIONS = {
    PatientJourneyState.UNREGISTERED: {
        PatientAction.SCAN_NFC: PatientJourneyState.ARRIVED,
    },
    PatientJourneyState.ARRIVED: {
        PatientAction.REGISTER: PatientJourneyState.REGISTERED,
        StaffAction.REGISTER_PATIENT: PatientJourneyState.REGISTERED,
    },
    # ... ëª¨ë“  ìƒíƒœë³„ ê°€ëŠ¥í•œ ì „ì´ ì •ì˜
}
```
- ìœ íš¨í•œ ì „ì´ë§Œ í—ˆìš© âœ“
- í™˜ì/ì§ì› ì•¡ì…˜ êµ¬ë¶„ âœ“
- ë¹„ì¦ˆë‹ˆìŠ¤ ê·œì¹™ ê°•ì œ âœ“

1.4 Queue â†” PatientState ì–‘ë°©í–¥ ë™ê¸°í™”
```python
def sync_from_queue_update(self, queue: Queue):
    """Queue ë³€ê²½ â†’ PatientState ë™ê¸°í™”"""
    queue_state = QueueDetailState(queue.state)
    journey_state = QUEUE_TO_JOURNEY_MAPPING.get(queue_state)
    
def sync_from_patient_state(self, patient_state: PatientState):
    """PatientState ë³€ê²½ â†’ Queue ë™ê¸°í™”"""
    journey_state = PatientJourneyState(patient_state.current_state)
    queue_state = JOURNEY_TO_QUEUE_MAPPING.get(journey_state)
```
- ì¼ê´€ëœ ìƒíƒœ ìœ ì§€ âœ“
- ë§¤í•‘ í…Œì´ë¸”ë¡œ ê´€ë¦¬ âœ“

ã€âš ï¸ ë¬¸ì œê°€ ìˆëŠ” ë¶€ë¶„ã€‘

1.5 ìƒíƒœ ë³µì¡ì„± ë¬¸ì œ
```python
# 9ë‹¨ê³„ê°€ ë„ˆë¬´ ì„¸ë¶„í™”ë¨
# COMPLETED â†’ WAITING ì „ì´ (ë‹¤ìŒ ê²€ì‚¬) ë¡œì§ ë³µì¡
# PAYMENT íŒë‹¨ ì‹œ ëª¨ë“  ê²€ì‚¬ ì™„ë£Œ í™•ì¸ í•„ìš”
if all_exams_completed and not payment_done:
    state = PatientJourneyState.PAYMENT
elif some_exams_remaining:
    state = PatientJourneyState.WAITING  # ë‹¤ì‹œ ëŒ€ê¸°
```

1.6 ë™ê¸°í™” Race Condition
```python
# Queueì™€ PatientState ë™ì‹œ ë³€ê²½ ì‹œ ë¬¸ì œ
def sync_from_queue_update():
    # PatientState ë³€ê²½ â†’ sync_from_patient_state í˜¸ì¶œ
    # â†’ Queue ë‹¤ì‹œ ë³€ê²½ â†’ ë¬´í•œ ë£¨í”„ ê°€ëŠ¥ì„±
```

1.7 ìƒíƒœ ë²„ì „ ê´€ë¦¬ ë¶€ì¬
```python
# í´ë¼ì´ì–¸íŠ¸-ì„œë²„ ìƒíƒœ ë¶ˆì¼ì¹˜ ì‹œ í™•ì¸ ë°©ë²• ì—†ìŒ
# ë‹¤ì¤‘ íƒ­/ë””ë°”ì´ìŠ¤ì—ì„œ ìƒíƒœ ì¶©ëŒ ê°€ëŠ¥
```

================================================================================
2. í”„ë¡ íŠ¸ì—”ë“œ ìƒíƒœ ê´€ë¦¬ ì‹œìŠ¤í…œ
================================================================================

ã€âœ… ì˜ êµ¬í˜„ëœ ë¶€ë¶„ã€‘

2.1 journeyStore (Zustand)
```javascript
const useJourneyStore = create((set, get) => ({
    // í•µì‹¬ ìƒíƒœ
    patientState: null,
    todaysAppointments: [],
    currentQueues: [],
    nextExam: null,
    locationInfo: null,
    
    // í†µí•© ë°ì´í„° í˜ì¹­
    fetchJourneyData: async () => {
        const [appointments, queues, state] = await Promise.all([
            appointmentAPI.getTodaysAppointments(),
            queueAPI.getMyQueues(),
            patientStateAPI.getCurrentState()
        ]);
        
        set({
            todaysAppointments: appointments,
            currentQueues: queues,
            patientState: state.journey_state
        });
    },
    
    // ê³„ì‚°ëœ ì…€ë ‰í„°
    getTodaysScheduleForUI: () => {
        // ë³µì¡í•œ UI ë¡œì§ ì¤‘ì•™í™”
        return formatScheduleForDisplay(get().todaysAppointments);
    }
}));
```
- ì¤‘ì•™í™”ëœ ìƒíƒœ ê´€ë¦¬ âœ“
- íš¨ìœ¨ì ì¸ ë°ì´í„° í˜ì¹­ âœ“
- ê³„ì‚° ë¡œì§ ìº¡ìŠí™” âœ“

2.2 WebSocket ì‹¤ì‹œê°„ í†µì‹ 
```javascript
// usePatientJourney.js
const usePatientJourney = () => {
    const ws = useRef(null);
    
    const connectWebSocket = () => {
        ws.current = new WebSocket(`ws://localhost:8000/ws/journey/${userId}/`);
        
        ws.current.onmessage = (event) => {
            const data = JSON.parse(event.data);
            
            switch(data.type) {
                case 'state_update':
                    updateJourneyState(data.journey_state);
                    break;
                case 'queue_update':
                    updateQueueInfo(data.queue_data);
                    break;
            }
        };
    };
    
    // ì•¡ì…˜ í—¬í¼ í•¨ìˆ˜ë“¤
    const scanNFC = (tagCode) => sendAction('scan_nfc', { tag_code: tagCode });
    const register = () => sendAction('register');
    const confirmArrival = (examId) => sendAction('confirm_arrival', { exam_id: examId });
```
- WebSocket ê¸°ë°˜ ì‹¤ì‹œê°„ ì—…ë°ì´íŠ¸ âœ“
- íƒ€ì…ë³„ ë©”ì‹œì§€ ì²˜ë¦¬ âœ“
- í¸ë¦¬í•œ ì•¡ì…˜ í—¬í¼ âœ“

2.3 ìƒíƒœë³„ í™”ë©´ ë¼ìš°íŒ…
```javascript
// JourneyContainer.jsx
const JourneyContainer = () => {
    const { patientState, loading } = useJourneyStore();
    
    const renderScreen = () => {
        switch(patientState) {
            case 'UNREGISTERED': return <UnregisteredScreen />;
            case 'ARRIVED': return <ArrivedScreen />;
            case 'REGISTERED': return <RegisteredScreen />;
            case 'WAITING':
            case 'CALLED':
            case 'IN_PROGRESS': return <WaitingScreen />;
            case 'COMPLETED': return <WaitingScreen nextExam={true} />;
            case 'PAYMENT': return <PaymentScreen />;
            case 'FINISHED': return <FinishedScreen />;
        }
    };
    
    return (
        <AnimatePresence mode="wait">
            {renderScreen()}
        </AnimatePresence>
    );
};
```
- ëª…í™•í•œ í™”ë©´ ë¶„ê¸° âœ“
- ì• ë‹ˆë©”ì´ì…˜ ì „í™˜ âœ“
- ì»´í¬ë„ŒíŠ¸ ì¬ì‚¬ìš© âœ“

ã€âš ï¸ ë¬¸ì œê°€ ìˆëŠ” ë¶€ë¶„ã€‘

2.4 WebSocket ì¬ì—°ê²° ë¡œì§ ë¯¸í¡
```javascript
// í˜„ì¬: ì—°ê²° ëŠê¹€ ì‹œ ì²˜ë¦¬ ë¶€ì¡±
ws.current.onclose = () => {
    console.log('WebSocket closed');
    // ì¬ì—°ê²° ì‹œë„ ì—†ìŒ
    // HTTP í´ë°± ë¶ˆì™„ì „
};
```

2.5 ìƒíƒœ ê³„ì‚° ì¤‘ë³µ
```javascript
// journeyStoreì—ì„œ ê³„ì‚°
getNextExam: () => { /* ë³µì¡í•œ ë¡œì§ */ }

// ì»´í¬ë„ŒíŠ¸ì—ì„œ ë˜ ê³„ì‚°
const nextExam = useMemo(() => {
    // ë¹„ìŠ·í•œ ë¡œì§ ì¤‘ë³µ
}, [appointments, currentQueues]);
```

2.6 ë‚™ê´€ì  ì—…ë°ì´íŠ¸ ë¶€ì¬
```javascript
// í˜„ì¬: ì„œë²„ ì‘ë‹µ ëŒ€ê¸°
const performAction = async (action) => {
    setLoading(true);
    await api.performAction(action);  // ëŠë¦° UX
    await fetchJourneyData();
    setLoading(false);
};
```

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸ”¥ ì£¼ìš” ë¬¸ì œì  ë° ì˜í–¥ë„
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ë¬¸ì œì                 â”‚ ì‹¬ê°ë„ â”‚ ì˜í–¥ ë²”ìœ„      â”‚ ìˆ˜ì • ì‹œê°„ â”‚ ìš°ì„ ìˆœìœ„ â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 9ë‹¨ê³„ ìƒíƒœ ë³µì¡ì„±     â”‚ ë†’ìŒ   â”‚ ìœ ì§€ë³´ìˆ˜      â”‚ 2ì¼       â”‚ P1      â”‚
â”‚ ë™ê¸°í™” Race Conditionâ”‚ ë†’ìŒ   â”‚ ë°ì´í„° ì¼ê´€ì„±  â”‚ 1ì¼       â”‚ P1      â”‚
â”‚ WebSocket ì¬ì—°ê²° ë¶€ì¬â”‚ ì¤‘ê°„   â”‚ ì•ˆì •ì„±        â”‚ 1ì¼       â”‚ P2      â”‚
â”‚ ìƒíƒœ ë²„ì „ ê´€ë¦¬ ë¶€ì¬  â”‚ ì¤‘ê°„   â”‚ ë™ê¸°í™”        â”‚ 1ì¼       â”‚ P2      â”‚
â”‚ ë‚™ê´€ì  ì—…ë°ì´íŠ¸ ë¶€ì¬ â”‚ ë‚®ìŒ   â”‚ UX            â”‚ 1ì¼       â”‚ P3      â”‚
â”‚ ìƒíƒœ ê³„ì‚° ì¤‘ë³µ       â”‚ ë‚®ìŒ   â”‚ ì„±ëŠ¥          â”‚ 0.5ì¼     â”‚ P3      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸ’¡ ê°œì„  ë°©ì•ˆ (ìš°ì„ ìˆœìœ„ìˆœ)
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

================================================================================
[P1] ìƒíƒœ ë‹¨ìˆœí™” - 9ë‹¨ê³„ â†’ 5ë‹¨ê³„ (2ì¼)
================================================================================

ã€ë°±ì—”ë“œ ìƒíƒœ ê·¸ë£¹í™”ã€‘
```python
# state_definitions.py
class SimplifiedPatientState(Enum):
    CHECK_IN = "CHECK_IN"          # UNREGISTERED + ARRIVED + REGISTERED
    WAITING = "WAITING"            # WAITING
    IN_PROGRESS = "IN_PROGRESS"   # CALLED + IN_PROGRESS
    COMPLETED = "COMPLETED"        # COMPLETED (ê²€ì‚¬ë³„)
    FINISHED = "FINISHED"          # PAYMENT + FINISHED

# ìƒíƒœ ê·¸ë£¹ ë§¤í•‘
STATE_GROUPS = {
    'CHECK_IN': ['UNREGISTERED', 'ARRIVED', 'REGISTERED'],
    'WAITING': ['WAITING'],
    'IN_PROGRESS': ['CALLED', 'IN_PROGRESS'],
    'COMPLETED': ['COMPLETED'],
    'FINISHED': ['PAYMENT', 'FINISHED']
}

# ì„œë¹„ìŠ¤ ìˆ˜ì •
class PatientJourneyService:
    def get_simplified_state(self):
        """UIìš© ë‹¨ìˆœí™”ëœ ìƒíƒœ ë°˜í™˜"""
        current = self.patient_state.current_state
        for group, states in STATE_GROUPS.items():
            if current in states:
                return group
        return 'CHECK_IN'
```

ã€í”„ë¡ íŠ¸ì—”ë“œ ë‹¨ìˆœí™”ã€‘
```javascript
// JourneyContainer.jsx
const renderScreen = () => {
    const simplified = getSimplifiedState(patientState);
    
    switch(simplified) {
        case 'CHECK_IN': 
            return <CheckInFlow state={patientState} />;
        case 'WAITING':
        case 'IN_PROGRESS':
            return <ExamFlow state={patientState} />;
        case 'COMPLETED':
            return hasMoreExams ? <ExamFlow next={true} /> : <PaymentFlow />;
        case 'FINISHED':
            return <CompletionScreen />;
    }
};
```

================================================================================
[P1] ë™ê¸°í™” Race Condition í•´ê²° (1ì¼)
================================================================================

ã€ë°±ì—”ë“œ í†µí•© ì—…ë°ì´íŠ¸ã€‘
```python
# services.py
class PatientJourneyService:
    @transaction.atomic
    def unified_state_update(self, trigger: str, new_state: str, context: dict):
        """ë‹¨ì¼ íŠ¸ëœì­ì…˜ìœ¼ë¡œ ëª¨ë“  ìƒíƒœ ë™ê¸°í™”"""
        
        # ë™ê¸°í™” í”Œë˜ê·¸ë¡œ ë¬´í•œ ë£¨í”„ ë°©ì§€
        if context.get('_is_sync_update'):
            return
        
        # 1. PatientState ì—…ë°ì´íŠ¸
        patient_state = self._get_or_create_patient_state()
        old_state = patient_state.current_state
        patient_state.current_state = new_state
        patient_state.save()
        
        # 2. Queue ìƒíƒœ ë™ê¸°í™” (í•„ìš”ì‹œ)
        if should_sync_queue(old_state, new_state):
            queue_state = JOURNEY_TO_QUEUE_MAPPING.get(new_state)
            if queue_state:
                Queue.objects.filter(
                    user=self.user,
                    state__in=['waiting', 'called', 'in_progress']
                ).update(
                    state=queue_state,
                    _is_sync_update=True  # í”Œë˜ê·¸ ì„¤ì •
                )
        
        # 3. ìƒíƒœ ì „í™˜ ë¡œê·¸
        StateTransition.objects.create(
            user=self.user,
            from_state=old_state,
            to_state=new_state,
            trigger_type=trigger,
            version=patient_state.version + 1  # ë²„ì „ ì¦ê°€
        )
        
        # 4. WebSocket ì•Œë¦¼ (íŠ¸ëœì­ì…˜ ì»¤ë°‹ í›„)
        transaction.on_commit(
            lambda: self._send_state_update(new_state, trigger)
        )
```

================================================================================
[P2] WebSocket ì¬ì—°ê²° ë©”ì»¤ë‹ˆì¦˜ (1ì¼)
================================================================================

ã€í”„ë¡ íŠ¸ì—”ë“œ ì¬ì—°ê²° ë¡œì§ã€‘
```javascript
// usePatientJourney.js
const usePatientJourney = () => {
    const ws = useRef(null);
    const reconnectTimer = useRef(null);
    const reconnectAttempts = useRef(0);
    const maxReconnectAttempts = 5;
    
    const connectWebSocket = () => {
        const wsUrl = `ws://localhost:8000/ws/journey/${userId}/`;
        
        try {
            ws.current = new WebSocket(wsUrl);
            
            ws.current.onopen = () => {
                console.log('WebSocket connected');
                reconnectAttempts.current = 0;
                
                // ì—°ê²° ì„±ê³µ ì‹œ ì„œë²„ì™€ ìƒíƒœ ë™ê¸°í™”
                ws.current.send(JSON.stringify({
                    type: 'sync_request',
                    version: getCurrentStateVersion()
                }));
            };
            
            ws.current.onclose = (event) => {
                console.log('WebSocket closed:', event);
                
                // ì •ìƒ ì¢…ë£Œê°€ ì•„ë‹ˆë©´ ì¬ì—°ê²° ì‹œë„
                if (!event.wasClean) {
                    scheduleReconnect();
                }
            };
            
            ws.current.onerror = (error) => {
                console.error('WebSocket error:', error);
                // HTTP í´ë°± ëª¨ë“œë¡œ ì „í™˜
                fallbackToHTTP();
            };
            
            ws.current.onmessage = handleMessage;
            
        } catch (error) {
            console.error('WebSocket creation failed:', error);
            fallbackToHTTP();
        }
    };
    
    const scheduleReconnect = () => {
        if (reconnectAttempts.current >= maxReconnectAttempts) {
            console.log('Max reconnection attempts reached');
            fallbackToHTTP();
            return;
        }
        
        const delay = Math.min(1000 * Math.pow(2, reconnectAttempts.current), 30000);
        reconnectTimer.current = setTimeout(() => {
            reconnectAttempts.current++;
            console.log(`Reconnection attempt ${reconnectAttempts.current}`);
            connectWebSocket();
        }, delay);
    };
    
    const fallbackToHTTP = () => {
        console.log('Falling back to HTTP polling');
        // 10ì´ˆë§ˆë‹¤ ìƒíƒœ í´ë§
        setInterval(async () => {
            const state = await api.getCurrentState();
            updateLocalState(state);
        }, 10000);
    };
    
    // Heartbeat ë©”ì»¤ë‹ˆì¦˜
    useEffect(() => {
        const heartbeat = setInterval(() => {
            if (ws.current?.readyState === WebSocket.OPEN) {
                ws.current.send(JSON.stringify({ type: 'ping' }));
            }
        }, 30000);  // 30ì´ˆë§ˆë‹¤ ping
        
        return () => clearInterval(heartbeat);
    }, []);
};
```

================================================================================
[P2] ìƒíƒœ ë²„ì „ ê´€ë¦¬ (1ì¼)
================================================================================

ã€ë°±ì—”ë“œ ë²„ì „ ê´€ë¦¬ã€‘
```python
# models.py
class PatientState(models.Model):
    # ê¸°ì¡´ í•„ë“œë“¤...
    version = models.IntegerField(default=1)
    last_modified = models.DateTimeField(auto_now=True)
    
    def increment_version(self):
        self.version = F('version') + 1
        self.save(update_fields=['version', 'last_modified'])

# views.py
def get_current_state(request):
    state = PatientState.objects.get(user=request.user)
    return JsonResponse({
        'journey_state': state.current_state,
        'version': state.version,
        'last_modified': state.last_modified.isoformat(),
        'checksum': generate_state_checksum(state)
    })
```

ã€í”„ë¡ íŠ¸ì—”ë“œ ë²„ì „ ì²´í¬ã€‘
```javascript
// journeyStore.js
const useJourneyStore = create((set, get) => ({
    stateVersion: 0,
    
    syncWithServer: async () => {
        const serverState = await api.getCurrentState();
        const localVersion = get().stateVersion;
        
        if (serverState.version > localVersion) {
            // ì„œë²„ê°€ ë” ìµœì‹  - ë¡œì»¬ ì—…ë°ì´íŠ¸
            set({
                patientState: serverState.journey_state,
                stateVersion: serverState.version
            });
            
            // UI ìƒˆë¡œê³ ì¹¨
            await get().fetchJourneyData();
        } else if (serverState.version < localVersion) {
            // ë¡œì»¬ì´ ë” ìµœì‹  - ì¶©ëŒ í•´ê²°
            console.warn('State version conflict detected');
            // ì‚¬ìš©ìì—ê²Œ ì•Œë¦¼ ë˜ëŠ” ìë™ í•´ê²°
        }
    }
}));
```

================================================================================
[P3] ë‚™ê´€ì  ì—…ë°ì´íŠ¸ êµ¬í˜„ (1ì¼)
================================================================================

ã€í”„ë¡ íŠ¸ì—”ë“œ ë‚™ê´€ì  ì—…ë°ì´íŠ¸ã€‘
```javascript
// usePatientJourney.js
const performOptimisticAction = async (action, payload) => {
    // 1. ì˜ˆìƒ ê²°ê³¼ ì¦‰ì‹œ ì ìš© (ë‚™ê´€ì )
    const optimisticState = predictNextState(action, currentState);
    updateLocalState(optimisticState);
    
    // 2. UI ì¦‰ì‹œ ì—…ë°ì´íŠ¸
    setLoading(false);
    
    try {
        // 3. ì„œë²„ ìš”ì²­
        const result = await api.performAction(action, payload);
        
        // 4. ì„œë²„ ì‘ë‹µìœ¼ë¡œ í™•ì •
        updateLocalState(result.state);
        
    } catch (error) {
        // 5. ì‹¤íŒ¨ ì‹œ ë¡¤ë°±
        rollbackState();
        showError('ì‘ì—… ì‹¤íŒ¨. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
        
        // 6. ì‹¤íŒ¨í•œ ì•¡ì…˜ ì €ì¥ (ì¬ì‹œë„ìš©)
        saveFailedAction(action, payload);
    }
};

// ìƒíƒœ ì˜ˆì¸¡ í•¨ìˆ˜
const predictNextState = (action, currentState) => {
    const transitions = {
        'UNREGISTERED': { 'scan_nfc': 'ARRIVED' },
        'ARRIVED': { 'register': 'REGISTERED' },
        'REGISTERED': { 'join_queue': 'WAITING' },
        // ...
    };
    
    return transitions[currentState]?.[action] || currentState;
};
```

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸ“Š ê°œì„  í›„ ì˜ˆìƒ íš¨ê³¼
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

ã€ë³µì¡ë„ ê°ì†Œã€‘
â€¢ 9ë‹¨ê³„ â†’ 5ë‹¨ê³„ë¡œ ìƒíƒœ ë‹¨ìˆœí™”
â€¢ ìœ ì§€ë³´ìˆ˜ ë¹„ìš© 50% ê°ì†Œ
â€¢ ì‹ ê·œ ê°œë°œì í•™ìŠµ ê³¡ì„  ì™„í™”

ã€ì•ˆì •ì„± í–¥ìƒã€‘
â€¢ Race condition í•´ê²°ë¡œ ë°ì´í„° ì¼ê´€ì„± ë³´ì¥
â€¢ WebSocket ì¬ì—°ê²°ë¡œ ì—°ê²° ì•ˆì •ì„± 95% í–¥ìƒ
â€¢ ë²„ì „ ê´€ë¦¬ë¡œ ìƒíƒœ ì¶©ëŒ ë°©ì§€

ã€ì‚¬ìš©ì ê²½í—˜ã€‘
â€¢ ë‚™ê´€ì  ì—…ë°ì´íŠ¸ë¡œ ì²´ê° ì†ë„ 3ë°° í–¥ìƒ
â€¢ ë„¤íŠ¸ì›Œí¬ ì¥ì•  ì‹œì—ë„ ì„œë¹„ìŠ¤ ì§€ì†
â€¢ ëª…í™•í•œ ìƒíƒœ ì „í™˜ í”¼ë“œë°±

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
âœ… ì²´í¬ë¦¬ìŠ¤íŠ¸
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

ã€í•„ìˆ˜ êµ¬í˜„ (1ì£¼ ë‚´)ã€‘
â–¡ 5ë‹¨ê³„ ìƒíƒœë¡œ ë‹¨ìˆœí™”
â–¡ í†µí•© ìƒíƒœ ì—…ë°ì´íŠ¸ í•¨ìˆ˜
â–¡ WebSocket ì¬ì—°ê²° ë©”ì»¤ë‹ˆì¦˜
â–¡ ìƒíƒœ ë²„ì „ ê´€ë¦¬

ã€ì„ íƒ êµ¬í˜„ (ì—¬ìœ  ìˆì„ ë•Œ)ã€‘
â–¡ ë‚™ê´€ì  ì—…ë°ì´íŠ¸
â–¡ ìƒíƒœ ë¨¸ì‹  ë¼ì´ë¸ŒëŸ¬ë¦¬ (XState)
â–¡ ì´ë²¤íŠ¸ ì†Œì‹± íŒ¨í„´
â–¡ CQRS íŒ¨í„´

ã€í…ŒìŠ¤íŠ¸ í•­ëª©ã€‘
â–¡ ìƒíƒœ ì „ì´ ìœ íš¨ì„±
â–¡ ë™ì‹œ ì—…ë°ì´íŠ¸ ì²˜ë¦¬
â–¡ WebSocket ì—°ê²° ì•ˆì •ì„±
â–¡ ë‹¤ì¤‘ íƒ­/ë””ë°”ì´ìŠ¤ ë™ê¸°í™”
â–¡ ë„¤íŠ¸ì›Œí¬ ì¥ì•  ë³µêµ¬

================================================================================
ê²°ë¡ : í™˜ì ì—¬ì • ìƒíƒœ ê´€ë¦¬ëŠ” ê¸°ëŠ¥ì ìœ¼ë¡œ ì™„ì„±ë„ê°€ ë†’ìœ¼ë‚˜,
     ìƒíƒœ ë³µì¡ì„±ê³¼ ë™ê¸°í™” ì•ˆì •ì„± ê°œì„ ì´ í•„ìš”í•¨
================================================================================