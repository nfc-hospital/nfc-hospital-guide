# ì „ì²´ ì‹œìŠ¤í…œ íë¦„ ë¶„ì„ (Overall System Flow Analysis)
ìƒì„±ì¼: 2025-01-09
ì‘ì„±ì: Claude
ìƒíƒœ: ë¶„ì„ ì™„ë£Œ

## 1. ì‹œìŠ¤í…œ ì•„í‚¤í…ì²˜ ê°œìš”

### 1.1 ì „ì²´ êµ¬ì¡°
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      ì‚¬ìš©ì ì ‘ì  (User Interface)             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚   í™˜ì PWA        â”‚   ê´€ë¦¬ì ëŒ€ì‹œë³´ë“œ  â”‚    ì±—ë´‡ ì„œë¹„ìŠ¤       â”‚
â”‚  (React+Vite)     â”‚    (React+Vite)   â”‚   (Flask+AI)        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚                   â”‚                     â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚   API Gateway    â”‚
                    â”‚  (Django REST)   â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚                   â”‚                   â”‚
    â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”
    â”‚  ì¸ì¦    â”‚      â”‚  ë¹„ì¦ˆë‹ˆìŠ¤    â”‚    â”‚  ì‹¤ì‹œê°„      â”‚
    â”‚  ì‹œìŠ¤í…œ  â”‚      â”‚    ë¡œì§      â”‚    â”‚  í†µì‹         â”‚
    â”‚  (JWT)  â”‚      â”‚  (Services)  â”‚    â”‚ (WebSocket)  â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
                             â”‚                   â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚
                    â”‚    Database     â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚  (MySQL/Redis)  â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 1.2 ë°ì´í„° íë¦„ íƒ€ì…
1. **ë™ê¸° API í˜¸ì¶œ**: REST APIë¥¼ í†µí•œ ìš”ì²­-ì‘ë‹µ
2. **ì‹¤ì‹œê°„ ì—…ë°ì´íŠ¸**: WebSocketì„ í†µí•œ ì–‘ë°©í–¥ í†µì‹ 
3. **ì´ë²¤íŠ¸ ë“œë¦¬ë¸**: Django Signalsë¥¼ í†µí•œ ë‚´ë¶€ í†µì‹ 
4. **ìºì‹œ ë ˆì´ì–´**: Redisë¥¼ í†µí•œ ë¹ ë¥¸ ë°ì´í„° ì ‘ê·¼

## 2. í™˜ì ì—¬ì • ì „ì²´ íë¦„ (Patient Journey Flow)

### 2.1 ë©”ì¸ í”Œë¡œìš° (9ë‹¨ê³„)
```
[ë³‘ì› ë„ì°© ì „]
UNREGISTERED â”€â”€â”
               â”‚
               â–¼
[ë³‘ì› ë„ì°©/NFC íƒœê·¸]
ARRIVED â”€â”€â”€â”€â”€â”€â”€â”
               â”‚
               â–¼
[ë¡œê·¸ì¸/ì ‘ìˆ˜ ì™„ë£Œ]
REGISTERED â”€â”€â”€â”€â”
               â”‚
               â–¼
[ëŒ€ê¸°ì—´ ë“±ë¡]
WAITING â”€â”€â”€â”€â”€â”€â”€â”
               â”‚
               â–¼
[ì˜ë£Œì§„ í˜¸ì¶œ]
CALLED â”€â”€â”€â”€â”€â”€â”€â”€â”
               â”‚
               â–¼
[ê²€ì‚¬/ì§„ë£Œ ì‹œì‘]
ONGOING â”€â”€â”€â”€â”€â”€â”€â”
               â”‚
               â–¼
[ê²€ì‚¬/ì§„ë£Œ ì™„ë£Œ]
COMPLETED â”€â”€â”€â”€â”€â”
               â”‚
               â–¼
[ìˆ˜ë‚© ëŒ€ê¸°/ì™„ë£Œ]
PAYMENT â”€â”€â”€â”€â”€â”€â”€â”
               â”‚
               â–¼
[ê·€ê°€ ì•ˆë‚´]
FINISHED
```

### 2.2 ê° ë‹¨ê³„ë³„ ì‹œìŠ¤í…œ ìƒí˜¸ì‘ìš©

#### UNREGISTERED â†’ ARRIVED
```python
# íŠ¸ë¦¬ê±°: NFC íƒœê·¸ ìŠ¤ìº”
1. Frontend: NFCReader.scan()
2. API: POST /api/v1/nfc/scan/
3. Backend: NFCViewSet.scan()
   - TagLog ìƒì„±
   - PatientState ì—…ë°ì´íŠ¸
   - Signal ë°œìƒ
4. WebSocket: queue_update ì´ë²¤íŠ¸ ì „ì†¡
5. Frontend: ìƒíƒœ ì—…ë°ì´íŠ¸
```

#### ARRIVED â†’ REGISTERED
```python
# íŠ¸ë¦¬ê±°: ê°„í¸ ë¡œê·¸ì¸
1. Frontend: LoginForm.submit()
2. API: POST /api/v1/auth/simple-login
3. Backend: AuthenticationView.simple_login()
   - User ì¸ì¦
   - JWT í† í° ìƒì„±
   - DeviceToken ì €ì¥
   - PatientState ì—…ë°ì´íŠ¸
4. Frontend: AuthContext ì—…ë°ì´íŠ¸
```

#### REGISTERED â†’ WAITING
```python
# íŠ¸ë¦¬ê±°: ëŒ€ê¸°ì—´ ë“±ë¡
1. Frontend: JourneyNavigator.checkIn()
2. API: POST /api/v1/queue/join
3. Backend: QueueViewSet.join()
   - Queue ìƒì„±
   - ëŒ€ê¸° ìˆœë²ˆ í• ë‹¹
   - ì˜ˆìƒ ì‹œê°„ ê³„ì‚°
   - QueueStatusLog ìƒì„±
4. WebSocket: ì‹¤ì‹œê°„ ëŒ€ê¸° í˜„í™© ë¸Œë¡œë“œìºìŠ¤íŠ¸
5. Frontend: WaitingScreen í‘œì‹œ
```

#### WAITING â†’ CALLED
```python
# íŠ¸ë¦¬ê±°: ê´€ë¦¬ì í˜¸ì¶œ
1. Admin Dashboard: CallPatient.click()
2. API: POST /api/v1/queue/medical/call-patient/
3. Backend: QueueViewSet.call_patient()
   - Queue.state = 'called'
   - called_at ê¸°ë¡
   - Notification ìƒì„±
4. WebSocket: patient_called ì´ë²¤íŠ¸
5. Frontend: CalledModal í‘œì‹œ
```

### 2.3 ë¬¸ì œì  ë° ë³µì¡ë„ ë¶„ì„

#### í˜„ì¬ ë¬¸ì œì 
1. **ìƒíƒœ ë™ê¸°í™” ë³µì¡ë„**: 3ê°œ ëª¨ë¸(Queue, PatientState, EmrSyncStatus) ê°„ ë™ê¸°í™”
2. **íŠ¸ëœì­ì…˜ ê²½ê³„ ëª¨í˜¸**: ì—¬ëŸ¬ ëª¨ë¸ ì—…ë°ì´íŠ¸ ì‹œ ì›ìì„± ë³´ì¥ ë¯¸í¡
3. **ì´ë²¤íŠ¸ ìˆœì„œ ë³´ì¥ ì•ˆë¨**: WebSocket ì´ë²¤íŠ¸ì™€ API ì‘ë‹µ ìˆœì„œ ë¶ˆì¼ì¹˜
4. **ë¡¤ë°± ë©”ì»¤ë‹ˆì¦˜ ë¶€ì¬**: ì‹¤íŒ¨ ì‹œ ì´ì „ ìƒíƒœë¡œ ë³µêµ¬ ë¶ˆê°€

#### ë³µì¡ë„ ì¸¡ì •
- **Cyclomatic Complexity**: 42 (ë§¤ìš° ë†’ìŒ)
- **ìƒíƒœ ì „ì´ ê²½ë¡œ**: 28ê°œ
- **ì˜ì¡´ì„± ê·¸ë˜í”„ ê¹Šì´**: 5ë‹¨ê³„

## 3. ì£¼ìš” ë°ì´í„° íë¦„ íŒ¨í„´

### 3.1 ì¸ì¦ í”Œë¡œìš°
```
[í™˜ì PWA]
    â”‚
    â”œâ”€[ê°„í¸ ë¡œê·¸ì¸]â”€â†’ /api/v1/auth/simple-login
    â”‚                    â”‚
    â”‚                    â”œâ”€â†’ User ì¡°íšŒ/ìƒì„±
    â”‚                    â”œâ”€â†’ JWT í† í° ìƒì„±
    â”‚                    â”œâ”€â†’ DeviceToken ì €ì¥
    â”‚                    â””â”€â†’ Response(token, user)
    â”‚
    â”œâ”€[í† í° ê°±ì‹ ]â”€â”€â”€â”€â†’ /api/v1/auth/token/refresh/
    â”‚                    â”‚
    â”‚                    â”œâ”€â†’ RefreshToken ê²€ì¦
    â”‚                    â”œâ”€â†’ ìƒˆ AccessToken ìƒì„±
    â”‚                    â””â”€â†’ Response(access_token)
    â”‚
    â””â”€[ì¸ì¦ ê²€ì¦]â”€â”€â”€â”€â†’ JWT Middleware
                         â”‚
                         â”œâ”€â†’ Token íŒŒì‹±
                         â”œâ”€â†’ Signature ê²€ì¦
                         â”œâ”€â†’ ë§Œë£Œ ì‹œê°„ í™•ì¸
                         â””â”€â†’ request.user ì„¤ì •
```

### 3.2 ì‹¤ì‹œê°„ ì—…ë°ì´íŠ¸ í”Œë¡œìš°
```
[Django Signal]
    â”‚
    â”œâ”€â†’ queue_status_changed
    â”‚      â”‚
    â”‚      â””â”€â†’ QueueConsumer.broadcast_update()
    â”‚             â”‚
    â”‚             â”œâ”€â†’ Redis Channel Layer
    â”‚             â”‚      â”‚
    â”‚             â”‚      â””â”€â†’ WebSocket Connection
    â”‚             â”‚             â”‚
    â”‚             â”‚             â””â”€â†’ [í™˜ì PWA]
    â”‚             â”‚
    â”‚             â””â”€â†’ ê´€ë¦¬ì ëŒ€ì‹œë³´ë“œ ì—…ë°ì´íŠ¸
    â”‚
    â””â”€â†’ patient_state_changed
           â”‚
           â””â”€â†’ StateTransition ë¡œê¹…
```

### 3.3 NFC íƒœê·¸ ì²˜ë¦¬ í”Œë¡œìš°
```
[NFC íƒœê·¸ ìŠ¤ìº”]
    â”‚
    â”œâ”€â†’ Web NFC API (NDEFReader)
    â”‚      â”‚
    â”‚      â”œâ”€â†’ NDEF ë©”ì‹œì§€ íŒŒì‹±
    â”‚      â”œâ”€â†’ Tag UID ì¶”ì¶œ
    â”‚      â””â”€â†’ /api/v1/nfc/scan/
    â”‚             â”‚
    â”‚             â”œâ”€â†’ NFCTag ì¡°íšŒ
    â”‚             â”œâ”€â†’ ìœ„ì¹˜ ì •ë³´ í™•ì¸
    â”‚             â”œâ”€â†’ TagLog ìƒì„±
    â”‚             â”œâ”€â†’ ê´€ë ¨ ê²€ì‚¬ì‹¤ ì •ë³´ ì¡°íšŒ
    â”‚             â””â”€â†’ ê²½ë¡œ ì•ˆë‚´ ìƒì„±
    â”‚
    â””â”€â†’ [iOS ëŒ€ì²´ ê²½ë¡œ]
           â”‚
           â””â”€â†’ QR ì½”ë“œ ìŠ¤ìº”
                  â”‚
                  â””â”€â†’ /api/v1/nfc/qr-backup/{tagId}
```

## 4. í•µì‹¬ í†µí•© ì§€ì  (Integration Points)

### 4.1 Frontend-Backend í†µí•©
```javascript
// API ì„œë¹„ìŠ¤ ë ˆì´ì–´
class APIService {
    constructor() {
        this.axios = axios.create({
            baseURL: 'https://api.nfc-hospital.kr/v1',
            timeout: 10000
        });
        
        // JWT ì¸í„°ì…‰í„°
        this.axios.interceptors.request.use(
            config => {
                const token = localStorage.getItem('access_token');
                if (token) {
                    config.headers.Authorization = `Bearer ${token}`;
                }
                return config;
            }
        );
        
        // ì—ëŸ¬ ì²˜ë¦¬ ì¸í„°ì…‰í„°
        this.axios.interceptors.response.use(
            response => response,
            async error => {
                if (error.response?.status === 401) {
                    // í† í° ê°±ì‹  ì‹œë„
                    await this.refreshToken();
                }
                return Promise.reject(error);
            }
        );
    }
}
```

### 4.2 WebSocket í†µí•©
```python
# Backend Consumer
class QueueConsumer(AsyncWebsocketConsumer):
    async def connect(self):
        self.queue_id = self.scope['url_route']['kwargs']['queue_id']
        self.queue_group = f'queue_{self.queue_id}'
        
        # ê·¸ë£¹ì— ì¶”ê°€
        await self.channel_layer.group_add(
            self.queue_group,
            self.channel_name
        )
        
        await self.accept()
    
    async def queue_update(self, event):
        # í´ë¼ì´ì–¸íŠ¸ë¡œ ë©”ì‹œì§€ ì „ì†¡
        await self.send(text_data=json.dumps({
            'type': 'queue.update',
            'data': event['data']
        }))
```

```javascript
// Frontend WebSocket Hook
const useWebSocket = (queueId) => {
    const [socket, setSocket] = useState(null);
    const [lastMessage, setLastMessage] = useState(null);
    
    useEffect(() => {
        const ws = new WebSocket(`ws://api.nfc-hospital.kr/ws/queue/${queueId}/`);
        
        ws.onmessage = (event) => {
            const data = JSON.parse(event.data);
            setLastMessage(data);
            
            // ìƒíƒœ ì—…ë°ì´íŠ¸
            if (data.type === 'queue.update') {
                updateQueueStatus(data.data);
            }
        };
        
        setSocket(ws);
        
        return () => ws.close();
    }, [queueId]);
    
    return { socket, lastMessage };
};
```

### 4.3 ìƒíƒœ ê´€ë¦¬ í†µí•©
```javascript
// Zustand Store
const useJourneyStore = create((set, get) => ({
    currentState: 'UNREGISTERED',
    queueInfo: null,
    appointments: [],
    
    // ìƒíƒœ ì „ì´ ì•¡ì…˜
    transitionTo: async (newState) => {
        const oldState = get().currentState;
        
        try {
            // Backend API í˜¸ì¶œ
            await api.updatePatientState(newState);
            
            // ë¡œì»¬ ìƒíƒœ ì—…ë°ì´íŠ¸
            set({ currentState: newState });
            
            // ë¶€ê°€ ì‘ì—…
            if (newState === 'WAITING') {
                await get().loadQueueInfo();
            }
        } catch (error) {
            // ë¡¤ë°±
            set({ currentState: oldState });
            throw error;
        }
    },
    
    // WebSocket ë©”ì‹œì§€ ì²˜ë¦¬
    handleWebSocketMessage: (message) => {
        if (message.type === 'state.changed') {
            set({ currentState: message.state });
        } else if (message.type === 'queue.update') {
            set({ queueInfo: message.queueInfo });
        }
    }
}));
```

## 5. ì‹œìŠ¤í…œ ë³‘ëª© ì§€ì  ë¶„ì„

### 5.1 ì„±ëŠ¥ ë³‘ëª©
1. **ë°ì´í„°ë² ì´ìŠ¤ ì¿¼ë¦¬**
   - N+1 ë¬¸ì œ: QueueViewSet.list()ì—ì„œ user, exam, appointment ì¡°íšŒ
   - í•´ê²°: select_related(), prefetch_related() ì ìš©
   
2. **WebSocket ë¸Œë¡œë“œìºìŠ¤íŠ¸**
   - ë¬¸ì œ: ëª¨ë“  ì—°ê²°ì— ë©”ì‹œì§€ ì „ì†¡ ì‹œ O(n) ë³µì¡ë„
   - í•´ê²°: Redis Pub/Sub íŒ¨í„´ í™œìš©

3. **SVG ë§µ ë¡œë”©**
   - ë¬¸ì œ: ëŒ€ìš©ëŸ‰ SVG íŒŒì¼ íŒŒì‹± ì§€ì—°
   - í•´ê²°: SVG ìµœì í™”, ë ˆì´ì–´ë³„ ì§€ì—° ë¡œë”©

### 5.2 í™•ì¥ì„± ë³‘ëª©
1. **ì„¸ì…˜ ê´€ë¦¬**
   - í˜„ì¬: Django ê¸°ë³¸ ì„¸ì…˜ (DB ì €ì¥)
   - ê°œì„ : Redis ì„¸ì…˜ ë°±ì—”ë“œ ì‚¬ìš©

2. **íŒŒì¼ ìŠ¤í† ë¦¬ì§€**
   - í˜„ì¬: ë¡œì»¬ íŒŒì¼ ì‹œìŠ¤í…œ
   - ê°œì„ : S3 ë“± í´ë¼ìš°ë“œ ìŠ¤í† ë¦¬ì§€

3. **ì‹¤ì‹œê°„ ì—°ê²°**
   - í˜„ì¬: ë‹¨ì¼ ì„œë²„ WebSocket
   - ê°œì„ : ë¡œë“œ ë°¸ëŸ°ì„œ + Sticky Session

## 6. ë³´ì•ˆ ì·¨ì•½ì  ë° ê°œì„ 

### 6.1 ì¸ì¦/ì¸ê°€
```python
# ë¬¸ì œ: JWT í† í° íƒˆì·¨ ì‹œ ë¬´íš¨í™” ë¶ˆê°€
# í•´ê²°: Redis ë¸”ë™ë¦¬ìŠ¤íŠ¸ êµ¬í˜„
class TokenBlacklist:
    def add(self, token, expiry):
        redis_client.setex(
            f"blacklist:{token}",
            expiry,
            "1"
        )
    
    def is_blacklisted(self, token):
        return redis_client.exists(f"blacklist:{token}")
```

### 6.2 XSS ë°©ì§€
```javascript
// ë¬¸ì œ: dangerouslySetInnerHTML ì‚¬ìš©
// í•´ê²°: DOMPurify ë¼ì´ë¸ŒëŸ¬ë¦¬ ì ìš©
import DOMPurify from 'dompurify';

const SafeSVGViewer = ({ svgContent }) => {
    const sanitized = DOMPurify.sanitize(svgContent, {
        USE_PROFILES: { svg: true }
    });
    
    return (
        <div 
            dangerouslySetInnerHTML={{ __html: sanitized }}
        />
    );
};
```

### 6.3 CSRF ë³´í˜¸
```python
# ë¬¸ì œ: WebSocketì— CSRF í† í° ê²€ì¦ ì—†ìŒ
# í•´ê²°: ì—°ê²° ì‹œ CSRF í† í° ê²€ì¦
class SecureWebSocketMiddleware:
    async def __call__(self, scope, receive, send):
        headers = dict(scope['headers'])
        csrf_token = headers.get(b'x-csrf-token', b'').decode()
        
        if not self.verify_csrf_token(csrf_token):
            await send({
                'type': 'websocket.close',
                'code': 4003  # Custom close code
            })
            return
        
        return await self.app(scope, receive, send)
```

## 7. ë°ì´í„° ì¼ê´€ì„± ë³´ì¥

### 7.1 íŠ¸ëœì­ì…˜ ê´€ë¦¬
```python
# ë¬¸ì œ: ì—¬ëŸ¬ ëª¨ë¸ ì—…ë°ì´íŠ¸ ì‹œ ë¶€ë¶„ ì‹¤íŒ¨ ê°€ëŠ¥
# í•´ê²°: ë°ì´í„°ë² ì´ìŠ¤ íŠ¸ëœì­ì…˜ ì‚¬ìš©
from django.db import transaction

class PatientJourneyService:
    @transaction.atomic
    def transition_state(self, user_id, new_state):
        # ëª¨ë“  ê´€ë ¨ ëª¨ë¸ì„ í•˜ë‚˜ì˜ íŠ¸ëœì­ì…˜ìœ¼ë¡œ ì²˜ë¦¬
        patient_state = PatientState.objects.select_for_update().get(
            user_id=user_id
        )
        
        old_state = patient_state.current_state
        patient_state.current_state = new_state
        patient_state.save()
        
        # ìƒíƒœ ì „ì´ ë¡œê·¸
        StateTransition.objects.create(
            user_id=user_id,
            from_state=old_state,
            to_state=new_state,
            trigger_type='manual'
        )
        
        # ëŒ€ê¸°ì—´ ìƒíƒœ ì—…ë°ì´íŠ¸
        if new_state == 'WAITING':
            Queue.objects.filter(
                user_id=user_id,
                state='pending'
            ).update(state='waiting')
        
        return patient_state
```

### 7.2 ì´ë²¤íŠ¸ ìˆœì„œ ë³´ì¥
```python
# ë¬¸ì œ: WebSocket ì´ë²¤íŠ¸ì™€ API ì‘ë‹µ ìˆœì„œ ë¶ˆì¼ì¹˜
# í•´ê²°: ì´ë²¤íŠ¸ ì‹œí€€ìŠ¤ ë²ˆí˜¸ ì‚¬ìš©
class OrderedEventBroadcaster:
    def __init__(self):
        self.sequence = 0
        self.lock = asyncio.Lock()
    
    async def broadcast(self, event_type, data):
        async with self.lock:
            self.sequence += 1
            event = {
                'seq': self.sequence,
                'type': event_type,
                'data': data,
                'timestamp': datetime.now().isoformat()
            }
            
            await self.channel_layer.group_send(
                'updates',
                {
                    'type': 'send.event',
                    'event': event
                }
            )
```

## 8. ì—ëŸ¬ ì²˜ë¦¬ ë° ë³µêµ¬

### 8.1 ê¸€ë¡œë²Œ ì—ëŸ¬ í•¸ë“¤ëŸ¬
```python
# Backend
class GlobalErrorMiddleware:
    def __init__(self, get_response):
        self.get_response = get_response
    
    def __call__(self, request):
        try:
            response = self.get_response(request)
        except ValidationError as e:
            return JsonResponse({
                'success': False,
                'error': {
                    'code': 'VALIDATION_ERROR',
                    'message': str(e),
                    'details': e.detail if hasattr(e, 'detail') else None
                }
            }, status=400)
        except Exception as e:
            logger.error(f"Unhandled error: {e}", exc_info=True)
            return JsonResponse({
                'success': False,
                'error': {
                    'code': 'INTERNAL_ERROR',
                    'message': 'An error occurred'
                }
            }, status=500)
        
        return response
```

```javascript
// Frontend
class ErrorBoundary extends React.Component {
    state = { hasError: false, error: null };
    
    static getDerivedStateFromError(error) {
        return { hasError: true, error };
    }
    
    componentDidCatch(error, errorInfo) {
        // ì—ëŸ¬ ë¡œê¹…
        console.error('Error caught:', error, errorInfo);
        
        // ì—ëŸ¬ ë¦¬í¬íŒ… ì„œë¹„ìŠ¤ë¡œ ì „ì†¡
        if (window.Sentry) {
            window.Sentry.captureException(error);
        }
    }
    
    render() {
        if (this.state.hasError) {
            return <ErrorFallback error={this.state.error} />;
        }
        
        return this.props.children;
    }
}
```

### 8.2 ì¬ì‹œë„ ë©”ì»¤ë‹ˆì¦˜
```javascript
// API ì¬ì‹œë„ ë¡œì§
const retryableRequest = async (fn, maxRetries = 3) => {
    let lastError;
    
    for (let i = 0; i < maxRetries; i++) {
        try {
            return await fn();
        } catch (error) {
            lastError = error;
            
            // ì¬ì‹œë„ ê°€ëŠ¥í•œ ì—ëŸ¬ì¸ì§€ í™•ì¸
            if (!isRetryableError(error)) {
                throw error;
            }
            
            // ì§€ìˆ˜ ë°±ì˜¤í”„
            const delay = Math.min(1000 * Math.pow(2, i), 10000);
            await new Promise(resolve => setTimeout(resolve, delay));
        }
    }
    
    throw lastError;
};

const isRetryableError = (error) => {
    return error.response?.status >= 500 || 
           error.code === 'ECONNABORTED' ||
           error.code === 'ETIMEDOUT';
};
```

## 9. ëª¨ë‹ˆí„°ë§ ë° ë¡œê¹…

### 9.1 êµ¬ì¡°í™”ëœ ë¡œê¹…
```python
import structlog

logger = structlog.get_logger()

class StructuredLoggingMiddleware:
    def __call__(self, request):
        # ìš”ì²­ ì»¨í…ìŠ¤íŠ¸ ì„¤ì •
        structlog.contextvars.bind_contextvars(
            request_id=str(uuid.uuid4()),
            user_id=request.user.id if request.user.is_authenticated else None,
            ip_address=request.META.get('REMOTE_ADDR'),
            method=request.method,
            path=request.path
        )
        
        start_time = time.time()
        
        try:
            response = self.get_response(request)
            
            # ì‘ë‹µ ë¡œê¹…
            logger.info(
                "request_completed",
                status_code=response.status_code,
                duration=time.time() - start_time
            )
            
            return response
        except Exception as e:
            logger.error(
                "request_failed",
                error=str(e),
                duration=time.time() - start_time,
                exc_info=True
            )
            raise
```

### 9.2 ì„±ëŠ¥ ëª¨ë‹ˆí„°ë§
```javascript
// Frontend ì„±ëŠ¥ ì¸¡ì •
class PerformanceMonitor {
    static measureAPICall(name, fn) {
        const startMark = `${name}-start`;
        const endMark = `${name}-end`;
        
        performance.mark(startMark);
        
        return fn().finally(() => {
            performance.mark(endMark);
            performance.measure(name, startMark, endMark);
            
            const measure = performance.getEntriesByName(name)[0];
            
            // ë©”íŠ¸ë¦­ ì „ì†¡
            this.sendMetric({
                name,
                duration: measure.duration,
                timestamp: Date.now()
            });
        });
    }
    
    static sendMetric(metric) {
        // Analytics ì„œë¹„ìŠ¤ë¡œ ì „ì†¡
        if (window.gtag) {
            window.gtag('event', 'timing_complete', {
                name: metric.name,
                value: Math.round(metric.duration)
            });
        }
    }
}
```

## 10. í•œ ë‹¬ ë‚´ ì™„ì„±ì„ ìœ„í•œ ì‹œìŠ¤í…œ ê°œì„  ìš°ì„ ìˆœìœ„

### 10.1 P1 - í•„ìˆ˜ ìˆ˜ì • (1ì£¼ì°¨)
1. **WebSocket URL ë§¤ì¹­ ìˆ˜ì •**
   - ë¬¸ì œ: Frontend-Backend ì—”ë“œí¬ì¸íŠ¸ ë¶ˆì¼ì¹˜
   - ì˜í–¥ë„: ì‹¤ì‹œê°„ ê¸°ëŠ¥ ì „ì²´ ì‘ë™ ë¶ˆê°€
   - ì˜ˆìƒ ì‹œê°„: 4ì‹œê°„

2. **JWT í† í° ë³´ì•ˆ ê°œì„ **
   - ë¬¸ì œ: localStorage ì €ì¥, ë¸”ë™ë¦¬ìŠ¤íŠ¸ ì—†ìŒ
   - ì˜í–¥ë„: ë³´ì•ˆ ì·¨ì•½ì 
   - ì˜ˆìƒ ì‹œê°„: 8ì‹œê°„

3. **ìƒíƒœ ë™ê¸°í™” íŠ¸ëœì­ì…˜**
   - ë¬¸ì œ: ë¶€ë¶„ ì‹¤íŒ¨ ì‹œ ë°ì´í„° ë¶ˆì¼ì¹˜
   - ì˜í–¥ë„: ë°ì´í„° ë¬´ê²°ì„± í›¼ì†
   - ì˜ˆìƒ ì‹œê°„: 12ì‹œê°„

### 10.2 P2 - ì„±ëŠ¥ ê°œì„  (2ì£¼ì°¨)
1. **N+1 ì¿¼ë¦¬ ìµœì í™”**
   - ì ìš© ëŒ€ìƒ: QueueViewSet, AppointmentViewSet
   - ê°œì„  íš¨ê³¼: API ì‘ë‹µ ì‹œê°„ 50% ë‹¨ì¶•
   - ì˜ˆìƒ ì‹œê°„: 8ì‹œê°„

2. **SVG ë§µ ìµœì í™”**
   - ë ˆì´ì–´ë³„ ë¶„ë¦¬, ì§€ì—° ë¡œë”©
   - ê°œì„  íš¨ê³¼: ì´ˆê¸° ë¡œë”© ì‹œê°„ 70% ë‹¨ì¶•
   - ì˜ˆìƒ ì‹œê°„: 12ì‹œê°„

3. **Redis ìºì‹± ì ìš©**
   - ëŒ€ìƒ: ìì£¼ ì¡°íšŒë˜ëŠ” ì •ì  ë°ì´í„°
   - ê°œì„  íš¨ê³¼: DB ë¶€í•˜ 30% ê°ì†Œ
   - ì˜ˆìƒ ì‹œê°„: 8ì‹œê°„

### 10.3 P3 - ì•ˆì •ì„± ê°•í™” (3ì£¼ì°¨)
1. **ì—ëŸ¬ ì²˜ë¦¬ í†µí•©**
   - Global Error Boundary êµ¬í˜„
   - ì‚¬ìš©ì ì¹œí™”ì  ì—ëŸ¬ ë©”ì‹œì§€
   - ì˜ˆìƒ ì‹œê°„: 8ì‹œê°„

2. **ì¬ì‹œë„ ë©”ì»¤ë‹ˆì¦˜**
   - API í˜¸ì¶œ ì‹¤íŒ¨ ì‹œ ìë™ ì¬ì‹œë„
   - WebSocket ì¬ì—°ê²° ë¡œì§
   - ì˜ˆìƒ ì‹œê°„: 6ì‹œê°„

3. **ëª¨ë‹ˆí„°ë§ êµ¬í˜„**
   - êµ¬ì¡°í™”ëœ ë¡œê¹…
   - ì„±ëŠ¥ ë©”íŠ¸ë¦­ ìˆ˜ì§‘
   - ì˜ˆìƒ ì‹œê°„: 8ì‹œê°„

### 10.4 ì œì™¸í•  ë³µì¡ë„ (ì‹œê°„ ì ˆì•½)
1. **9ë‹¨ê³„ â†’ 5ë‹¨ê³„ ìƒíƒœ ê°„ì†Œí™”**
   - UNREGISTERED, ARRIVED í†µí•©
   - CALLED, ONGOING í†µí•©
   - ì ˆì•½ ì‹œê°„: 20ì‹œê°„

2. **ì‹¤ì‹œê°„ ê¸°ëŠ¥ ìµœì†Œí™”**
   - ì±—ë´‡ WebSocket ì œê±°
   - ê´€ë¦¬ì ëŒ€ì‹œë³´ë“œ ì‹¤ì‹œê°„ ì œí•œ
   - ì ˆì•½ ì‹œê°„: 16ì‹œê°„

3. **ì™¸ë¶€ ì—°ë™ Mock ì²˜ë¦¬**
   - EMR ì—°ë™ â†’ JSON ì‹œë“œ ë°ì´í„°
   - LSTM ì˜ˆì¸¡ â†’ ê³ ì •ê°’ ë°˜í™˜
   - ì ˆì•½ ì‹œê°„: 24ì‹œê°„

## 11. ë°ëª¨ ì‹œë‚˜ë¦¬ì˜¤ ìµœì í™”

### 11.1 í•µì‹¬ ë°ëª¨ í”Œë¡œìš° (15ë¶„)
```
1. [2ë¶„] ì‹œìŠ¤í…œ ì†Œê°œ
   - NFC ê¸°ë°˜ ë³‘ì› ì•ˆë‚´ ì‹œìŠ¤í…œ
   - ê³ ë ¹ì ì¹œí™”ì  UI
   
2. [3ë¶„] í™˜ì ë„ì°© ë° ì¸ì¦
   - NFC íƒœê·¸ ìŠ¤ìº” ì‹œì—°
   - ê°„í¸ ë¡œê·¸ì¸ (ì „í™”ë²ˆí˜¸ ë’·ìë¦¬ + ìƒë…„ì›”ì¼)
   
3. [5ë¶„] ëŒ€ê¸° ë° í˜¸ì¶œ
   - ì‹¤ì‹œê°„ ëŒ€ê¸° ìˆœë²ˆ í‘œì‹œ
   - ê´€ë¦¬ì í˜¸ì¶œ â†’ í™˜ì ì•Œë¦¼
   - ê²½ë¡œ ì•ˆë‚´ í‘œì‹œ
   
4. [3ë¶„] ê²€ì‚¬ ì™„ë£Œ íë¦„
   - ìƒíƒœ ìë™ ì „í™˜
   - ë‹¤ìŒ ì¼ì • ì•ˆë‚´
   
5. [2ë¶„] ì§ˆì˜ì‘ë‹µ
```

### 11.2 ë°±ì—… ì‹œë‚˜ë¦¬ì˜¤
- NFC ì‹¤íŒ¨ ì‹œ: QR ì½”ë“œ ëŒ€ì²´
- ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ ì‹œ: ì˜¤í”„ë¼ì¸ ëª¨ë“œ ë°ëª¨
- WebSocket ì‹¤íŒ¨ ì‹œ: Polling ëŒ€ì²´

## 12. ê²°ë¡  ë° ê¶Œê³ ì‚¬í•­

### 12.1 í˜„ì¬ ìƒíƒœ í‰ê°€
- **ì „ì²´ ì™„ì„±ë„**: 75%
- **í•µì‹¬ ê¸°ëŠ¥ ì™„ì„±ë„**: 85%
- **í†µí•© í…ŒìŠ¤íŠ¸ í•„ìš”ë„**: ë†’ìŒ
- **1ê°œì›” ë‚´ ì™„ì„± ê°€ëŠ¥ì„±**: 80% (ê¶Œê³ ì‚¬í•­ ì¤€ìˆ˜ ì‹œ)

### 12.2 íŒ€ë³„ ì‘ì—… ë¶„ë‹´ (3ëª…)
1. **ê°œë°œì A (ë°±ì—”ë“œ ë‹´ë‹¹)**
   - WebSocket ìˆ˜ì •
   - íŠ¸ëœì­ì…˜ ì²˜ë¦¬
   - API ìµœì í™”

2. **ê°œë°œì B (í”„ë¡ íŠ¸ì—”ë“œ ë‹´ë‹¹)**
   - ìƒíƒœ ê´€ë¦¬ ê°œì„ 
   - UI/UX ë²„ê·¸ ìˆ˜ì •
   - ì—ëŸ¬ ì²˜ë¦¬

3. **ê°œë°œì C (í†µí•©/í…ŒìŠ¤íŠ¸ ë‹´ë‹¹)**
   - í†µí•© í…ŒìŠ¤íŠ¸
   - ë°ëª¨ ì¤€ë¹„
   - ë¬¸ì„œí™”

### 12.3 ìµœì¢… ì²´í¬ë¦¬ìŠ¤íŠ¸
- [ ] WebSocket ì—”ë“œí¬ì¸íŠ¸ ì¼ì¹˜ í™•ì¸
- [ ] JWT í† í° ë³´ì•ˆ ê°•í™”
- [ ] íŠ¸ëœì­ì…˜ ì›ìì„± ë³´ì¥
- [ ] N+1 ì¿¼ë¦¬ í•´ê²°
- [ ] ì—ëŸ¬ ì²˜ë¦¬ í†µí•©
- [ ] ì¬ì‹œë„ ë©”ì»¤ë‹ˆì¦˜ êµ¬í˜„
- [ ] 5ë‹¨ê³„ ìƒíƒœë¡œ ê°„ì†Œí™”
- [ ] Mock ë°ì´í„° ì¤€ë¹„
- [ ] ë°ëª¨ ì‹œë‚˜ë¦¬ì˜¤ ë¦¬í—ˆì„¤
- [ ] ë°œí‘œ ìë£Œ ì¤€ë¹„

### 12.4 ë¦¬ìŠ¤í¬ ê´€ë¦¬
1. **ê¸°ìˆ ì  ë¦¬ìŠ¤í¬**
   - iOS Web NFC ë¯¸ì§€ì› â†’ QR ëŒ€ì²´
   - WebSocket ë¶ˆì•ˆì • â†’ Polling ë°±ì—…
   
2. **ì¼ì • ë¦¬ìŠ¤í¬**
   - í†µí•© í…ŒìŠ¤íŠ¸ ì§€ì—° â†’ ë‹¨ìœ„ í…ŒìŠ¤íŠ¸ ìš°ì„ 
   - ë²„ê·¸ ìˆ˜ì • ì§€ì—° â†’ í•µì‹¬ ê¸°ëŠ¥ ìš°ì„ 

3. **ë°ëª¨ ë¦¬ìŠ¤í¬**
   - ë„¤íŠ¸ì›Œí¬ ë¬¸ì œ â†’ ë¡œì»¬ í™˜ê²½ ì¤€ë¹„
   - í•˜ë“œì›¨ì–´ ë¬¸ì œ â†’ ë°±ì—… ì¥ë¹„ ì¤€ë¹„

---

## ë¶„ì„ ì™„ë£Œ
ì´ 7ê°œ ê¸°ëŠ¥ë³„ ìƒì„¸ ë¶„ì„ ë° ì „ì²´ ì‹œìŠ¤í…œ íë¦„ ë¶„ì„ì„ ì™„ë£Œí–ˆìŠµë‹ˆë‹¤.
í•œì´ìŒ ê³µëª¨ì „ ì„±ê³µì„ ê¸°ì›í•©ë‹ˆë‹¤! ğŸ¯