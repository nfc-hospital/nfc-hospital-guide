# Map Editor 개선 완료 - 시연용 경로 동적 추가 시스템

## 📊 Map-Editor 시스템 분석 결과

### 1. **기존 구조**

#### MapEditor.jsx (메인 페이지)
- ✅ 일반 시설 경로 / 시연용 경로 모드 전환
- ❌ **문제점**: 시연 시나리오 7개가 하드코딩됨 → 새 경로 추가 시 코드 수정 필요

#### MapNodeEditor.jsx (경로 편집 컴포넌트)
- ✅ **이미 구현됨**: 출발/도착 시설 선택 UI (16-18번 줄)
- ✅ **자동 경로명**: `route_출발_to_도착` 형식으로 저장 (639-653번 줄)
- ✅ **Multi-floor 지원**: 층간 이동 가능 (맵 전환 노드)
- ✅ **시설 위치 설정**: 시설의 x, y 좌표 지정 가능 (521-569번 줄)

#### Backend Models (hospital_navigation/models.py)
- `HospitalMap`: 건물/층별 지도 데이터
- `NavigationNode`: 경로상 노드 (NFC 태그, 검사실 등)
- `NavigationEdge`: 노드 간 연결선
- `PatientRoute`: 환자별 경로 정보 (출발-도착)

---

## 🚀 개선 사항

### ✨ 1. **동적 시연 시나리오 관리 시스템**

#### Before (하드코딩)
```javascript
const demoScenarios = [
  { id: '시연_P1_도착_원무과', name: 'P-1: 도착 → 원무과 접수', floor: '본관 1층', mapId: 'main_1f' },
  // ... 7개 고정
];
```

#### After (동적 추가/삭제)
```javascript
// localStorage에 저장되는 동적 시나리오
const [demoScenarios, setDemoScenarios] = useState(() => {
  const saved = localStorage.getItem('demoScenarios');
  return saved ? JSON.parse(saved) : [ /* 기본 7개 */ ];
});
```

### 🎯 2. **새 기능**

#### ① UI에서 시연 시나리오 추가
```
┌─────────────────────────────────────────┐
│ 🆕 새 시연 시나리오 추가                │
├─────────────────────────────────────────┤
│ 시나리오 ID *:  시연_P8_검사실_MRI     │
│ 시나리오 이름*: P-8: 검사실 → MRI      │
│ 층 정보:        본관 2층                │
│ 지도 ID:        [본관 2층 ▼]            │
├─────────────────────────────────────────┤
│        [✅ 추가]  [✕ 취소]              │
└─────────────────────────────────────────┘
```

#### ② 추가한 시나리오 삭제
- 기본 시연 시나리오 (P-1 ~ P-7)는 삭제 불가
- 사용자가 추가한 시나리오만 삭제 버튼 표시

#### ③ localStorage 자동 저장
- 추가/삭제 시 자동으로 localStorage에 저장
- 페이지 새로고침해도 유지됨

---

## 📝 사용 방법

### **시연용 경로 추가하기**

1. **Map Editor 접속**: `/map-editor`

2. **시연 모드 선택**: "🎬 시연용 경로" 버튼 클릭

3. **새 시나리오 추가**:
   - "새 시나리오 추가" 버튼 클릭
   - 폼 작성:
     - **시나리오 ID**: `시연_P8_검사실_MRI` (고유한 ID)
     - **시나리오 이름**: `P-8: 검사실 → MRI` (화면 표시명)
     - **층 정보**: `본관 2층` (설명용)
     - **지도 ID**: `main_2f` (시작 맵)
   - "✅ 추가" 클릭

4. **경로 그리기**:
   - 추가된 시나리오 카드 클릭
   - MapNodeEditor에서 지도 클릭 → 노드 추가
   - 노드 클릭 → 다른 노드 클릭 → 연결선 생성
   - "자동 정렬 (90도)" 버튼으로 정렬

5. **저장 및 활성화**:
   - "경로 저장 및 코드 생성" 버튼 클릭
   - "선택한 경로를 /home에 적용" 버튼으로 활성화

---

## 🛠️ 출발-도착 기반 경로 생성 (일반 모드)

### **시설 경로 만들기**

1. **일반 모드 선택**: "일반 시설 경로" 버튼

2. **출발/도착 시설 선택** (상단 경로 설정 바):
   ```
   경로 설정: 🟢 출발 [검사_채혈실 ▼] → 🔴 도착 [검사_MRI실 ▼]
   ```

3. **경로 그리기**:
   - 자동으로 출발 시설의 맵으로 전환됨
   - 지도 클릭 → 노드 추가
   - 층 이동이 필요하면:
     - 노드 선택 → "노드 타입" → "🟣 맵 전환 (층 이동)"
     - 다음 맵 선택 → "🟣 다음 맵으로 이동" 버튼 클릭

4. **경로 저장**:
   - 자동 경로명: `route_검사_채혈실_to_검사_MRI실`
   - localStorage + JSON 파일 다운로드

---

## 🎨 Multi-floor 경로 예시

### **1층 → 2층 경로**

```
[본관 1층 지도]
  노드1 (출발: 채혈실) → 노드2 → 노드3 (🟣 맵 전환: 엘리베이터)
                                           ↓
                                  [targetMap: main_2f]
                                  [targetNode: node-1]
                                           ↓
[본관 2층 지도]
  노드1 (엘리베이터) → 노드2 → 노드3 (🔴 도착: MRI실)
```

---

## 📂 저장 형식

### Multi-floor 경로 데이터
```json
{
  "routeName": "route_검사_채혈실_to_검사_MRI실",
  "startFacility": "검사_채혈실",
  "endFacility": "검사_MRI실",
  "maps": {
    "main_1f": {
      "nodes": [ /* 1층 노드 */ ],
      "edges": [ /* 1층 연결선 */ ],
      "nodeTypes": { "node-3": "map_transition" },
      "nodeTransitions": {
        "node-3": {
          "targetMap": "main_2f",
          "targetNode": "node-1"
        }
      }
    },
    "main_2f": {
      "nodes": [ /* 2층 노드 */ ],
      "edges": [ /* 2층 연결선 */ ]
    }
  },
  "createdAt": "2025-10-18T..."
}
```

---

## 🔥 핵심 개선 사항 요약

### Before
- ❌ 시연 시나리오 7개 하드코딩
- ❌ 새 경로 추가 시 코드 수정 필요
- ✅ 출발-도착 선택 기능은 이미 있었음

### After
- ✅ UI에서 시연 시나리오 동적 추가/삭제
- ✅ localStorage 자동 저장
- ✅ 기본 시나리오 보호 (P-1~P-7 삭제 불가)
- ✅ 출발-도착 기반 경로 생성 (이미 구현됨, 가이드만 추가)
- ✅ Multi-floor 지원 (이미 구현됨)

---

## 💡 추가 개선 제안

### 1. **시설 좌표 시각화**
- MapNodeEditor의 "시설 위치 설정" 모드 활용
- 출발/도착 시설의 좌표를 지도에 마커로 표시 (이미 구현됨: 710-762번 줄)

### 2. **경로 미리보기**
- 저장된 경로를 MapNavigator로 미리보기
- 실제 환자 화면에서 어떻게 보이는지 확인

### 3. **경로 템플릿**
- 자주 사용하는 경로 패턴을 템플릿으로 저장
- "로비 → 검사실 → 수납" 같은 기본 흐름 재사용

---

## 📌 참고 파일

- `frontend-pwa/src/pages/MapEditor.jsx` - 메인 에디터 (개선 완료)
- `frontend-pwa/src/components/MapNodeEditor.jsx` - 경로 편집 컴포넌트
- `backend/hospital_navigation/models.py` - DB 모델
- `frontend-pwa/src/data/facilityRoutes.js` - 시설 경로 데이터
