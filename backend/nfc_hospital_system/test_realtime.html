<!DOCTYPE html>
<html>
<head>
    <title>ğŸ¥ ì‹¤ì‹œê°„ ëŒ€ê¸°ì—´ ë°ì´í„° í…ŒìŠ¤íŠ¸</title>
    <meta charset="UTF-8">
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background-color: #f5f5f5; }
        .container { max-width: 1200px; margin: 0 auto; }
        .panel { 
            background: white; 
            padding: 20px; 
            margin: 10px 0; 
            border-radius: 8px; 
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .status { 
            padding: 10px; 
            margin: 10px 0;
            border-radius: 4px;
            font-weight: bold;
        }
        .connected { background-color: #d4edda; color: #155724; }
        .disconnected { background-color: #f8d7da; color: #721c24; }
        .messages { 
            height: 300px; 
            overflow-y: auto; 
            border: 1px solid #ddd; 
            padding: 10px;
            background-color: #f9f9f9;
        }
        .message { 
            margin: 5px 0; 
            padding: 8px;
            border-left: 3px solid #007bff;
            background-color: white;
            border-radius: 4px;
        }
        .real-time { border-left-color: #28a745; }
        .error { border-left-color: #dc3545; }
        .api-test { border-left-color: #ffc107; }
        button { 
            padding: 10px 15px; 
            margin: 5px;
            cursor: pointer;
            border: none;
            border-radius: 4px;
            background-color: #007bff;
            color: white;
        }
        button:hover { background-color: #0056b3; }
        button:disabled { background-color: #6c757d; cursor: not-allowed; }
        .test-buttons { display: flex; flex-wrap: wrap; gap: 10px; }
        .queue-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 15px 0;
        }
        .queue-card {
            background: #e9ecef;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ¥ NFC ë³‘ì› ì‹¤ì‹œê°„ ëŒ€ê¸°ì—´ ì‹œìŠ¤í…œ í…ŒìŠ¤íŠ¸</h1>
        
        <div class="panel">
            <h3>ğŸ“¡ WebSocket ì—°ê²° ìƒíƒœ</h3>
            <div id="status" class="status disconnected">ì—°ê²° ëŒ€ê¸° ì¤‘...</div>
            
            <div>
                <label>ëŒ€ê¸°ì—´ ID: </label>
                <input type="text" id="queueId" value="test123" placeholder="ëŒ€ê¸°ì—´ ID ì…ë ¥">
                <button onclick="loadRealQueueId()">ì‹¤ì œ ID ë¡œë“œ</button>
                <button onclick="connect()">ì—°ê²°</button>
                <button onclick="disconnect()">ì—°ê²° í•´ì œ</button>
            </div>
        </div>

        <div class="panel">
            <h3>ğŸ§ª ì‹¤ì‹œê°„ ë°ì´í„° í…ŒìŠ¤íŠ¸</h3>
            <div class="test-buttons">
                <button onclick="testQueueUpdate('waiting')" id="waitingBtn" disabled>ëŒ€ê¸° ìƒíƒœë¡œ ë³€ê²½</button>
                <button onclick="testQueueUpdate('called')" id="calledBtn" disabled>í˜¸ì¶œ ìƒíƒœë¡œ ë³€ê²½</button>
                <button onclick="testQueueUpdate('in_progress')" id="progressBtn" disabled>ì§„í–‰ì¤‘ìœ¼ë¡œ ë³€ê²½</button>
                <button onclick="testQueueUpdate('completed')" id="completedBtn" disabled>ì™„ë£Œë¡œ ë³€ê²½</button>
                <button onclick="getCurrentQueueData()" id="dataBtn" disabled>í˜„ì¬ ëŒ€ê¸°ì—´ ì¡°íšŒ</button>
            </div>
        </div>

        <div class="panel">
            <h3>ğŸ“Š í˜„ì¬ ëŒ€ê¸°ì—´ ì •ë³´</h3>
            <div class="queue-info" id="queueInfo">
                <div class="queue-card">
                    <h4>ì´ ëŒ€ê¸° ì¸ì›</h4>
                    <div id="totalCount">-</div>
                </div>
                <div class="queue-card">
                    <h4>í˜„ì¬ ì²˜ë¦¬ ì¤‘</h4>
                    <div id="processingCount">-</div>
                </div>
                <div class="queue-card">
                    <h4>í‰ê·  ëŒ€ê¸°ì‹œê°„</h4>
                    <div id="avgWaitTime">-</div>
                </div>
                <div class="queue-card">
                    <h4>ë§ˆì§€ë§‰ ì—…ë°ì´íŠ¸</h4>
                    <div id="lastUpdate">-</div>
                </div>
            </div>
        </div>

        <div class="panel">
            <h3>ğŸ“ ì‹¤ì‹œê°„ ë¡œê·¸</h3>
            <div class="messages" id="messages"></div>
            <button onclick="clearMessages()">ë¡œê·¸ ì§€ìš°ê¸°</button>
        </div>

        <div class="panel">
            <h3>ğŸ“‹ í…ŒìŠ¤íŠ¸ ê°€ì´ë“œ</h3>
            <ol>
                <li><strong>WebSocket ì—°ê²°:</strong> ëŒ€ê¸°ì—´ ID ì…ë ¥ í›„ "ì—°ê²°" í´ë¦­</li>
                <li><strong>ìƒíƒœ ë³€ê²½ í…ŒìŠ¤íŠ¸:</strong> ë²„íŠ¼ë“¤ì„ í´ë¦­í•´ì„œ ì‹¤ì œ DB ë°ì´í„° ë³€ê²½</li>
                <li><strong>ì‹¤ì‹œê°„ í™•ì¸:</strong> ë‹¤ë¥¸ ë¸Œë¼ìš°ì € íƒ­ì—ì„œ ê°™ì€ í˜ì´ì§€ ì—´ê³  ë™ì‹œ í™•ì¸</li>
                <li><strong>Django Admin:</strong> <a href="http://localhost:8000/admin/" target="_blank">ê´€ë¦¬ì í˜ì´ì§€</a>ì—ì„œ ì§ì ‘ ë°ì´í„° ìˆ˜ì •í•´ë³´ê¸°</li>
            </ol>
        </div>
    </div>

    <script>
        let socket = null;
        const messagesDiv = document.getElementById('messages');
        const statusDiv = document.getElementById('status');

        function addMessage(message, type = 'info') {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${type}`;
            messageDiv.innerHTML = `
                <strong>[${new Date().toLocaleTimeString()}]</strong> ${message}
            `;
            messagesDiv.appendChild(messageDiv);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }

        function updateStatus(connected) {
            const buttons = ['waitingBtn', 'calledBtn', 'progressBtn', 'completedBtn', 'dataBtn'];
            
            if (connected) {
                statusDiv.textContent = 'âœ… WebSocket ì—°ê²°ë¨ - ì‹¤ì‹œê°„ ì—…ë°ì´íŠ¸ í™œì„±í™”';
                statusDiv.className = 'status connected';
                buttons.forEach(id => document.getElementById(id).disabled = false);
            } else {
                statusDiv.textContent = 'âŒ WebSocket ì—°ê²° í•´ì œë¨';
                statusDiv.className = 'status disconnected';
                buttons.forEach(id => document.getElementById(id).disabled = true);
            }
        }

        function connect() {
            const queueId = document.getElementById('queueId').value.trim();
            if (!queueId) {
                addMessage('âŒ ëŒ€ê¸°ì—´ IDë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'error');
                return;
            }

            if (socket) {
                socket.close();
            }

            const wsUrl = `ws://localhost:8000/ws/queue/${queueId}/`;
            addMessage(`ğŸ”„ WebSocket ì—°ê²° ì‹œë„: ${wsUrl}`, 'info');
            
            socket = new WebSocket(wsUrl);

            socket.onopen = function(e) {
                addMessage('ğŸ‰ WebSocket ì—°ê²° ì„±ê³µ! ì‹¤ì‹œê°„ ì—…ë°ì´íŠ¸ê°€ í™œì„±í™”ë˜ì—ˆìŠµë‹ˆë‹¤.', 'real-time');
                updateStatus(true);
            };

            socket.onmessage = function(e) {
                const data = JSON.parse(e.data);
                
                if (data.type === 'queue_status_update') {
                    addMessage(`ğŸ”” ì‹¤ì‹œê°„ ëŒ€ê¸°ì—´ ì—…ë°ì´íŠ¸: ${JSON.stringify(data.data, null, 2)}`, 'real-time');
                    updateQueueInfo(data.data);
                } else if (data.type === 'personal_notification') {
                    addMessage(`ğŸ“¢ ê°œì¸ ì•Œë¦¼: ${data.data.message}`, 'real-time');
                } else if (data.type === 'log_update') {
                    addMessage(`ğŸ“„ ë¡œê·¸ ì—…ë°ì´íŠ¸: ${data.data.message}`, 'real-time');
                } else {
                    addMessage(`ğŸ“¨ ìˆ˜ì‹ : ${JSON.stringify(data, null, 2)}`, 'info');
                }
            };

            socket.onclose = function(e) {
                addMessage(`âŒ WebSocket ì—°ê²° í•´ì œ (ì½”ë“œ: ${e.code})`, 'error');
                updateStatus(false);
            };

            socket.onerror = function(e) {
                addMessage('ğŸ’¥ WebSocket ì˜¤ë¥˜ ë°œìƒ', 'error');
                updateStatus(false);
            };
        }

        function disconnect() {
            if (socket) {
                socket.close();
                socket = null;
            }
        }

        function testQueueUpdate(newState) {
            addMessage(`ğŸ§ª API í…ŒìŠ¤íŠ¸: ëŒ€ê¸°ì—´ ìƒíƒœë¥¼ '${newState}'ë¡œ ë³€ê²½ ìš”ì²­`, 'api-test');
            
            fetch('http://localhost:8000/api/v1/queue/test-update/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify({
                    'state': newState
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    addMessage(`âœ… API ì„±ê³µ: ${data.message}`, 'api-test');
                } else {
                    addMessage(`âŒ API ì‹¤íŒ¨: ${data.error || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'}`, 'error');
                }
            })
            .catch(error => {
                addMessage(`ğŸ’¥ API ì˜¤ë¥˜: ${error.message}`, 'error');
            });
        }

        function getCurrentQueueData() {
            addMessage('ğŸ“Š í˜„ì¬ ëŒ€ê¸°ì—´ ë°ì´í„° ì¡°íšŒ ì¤‘...', 'api-test');
            
            fetch('http://localhost:8000/api/v1/queue/', {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json'
                }
            })
            .then(response => response.json())
            .then(data => {
                addMessage(`ğŸ“Š í˜„ì¬ ëŒ€ê¸°ì—´ ë°ì´í„°: ${JSON.stringify(data, null, 2)}`, 'api-test');
                if (data.results) {
                    updateQueueInfo({total_count: data.results.length});
                }
            })
            .catch(error => {
                addMessage(`ğŸ’¥ ë°ì´í„° ì¡°íšŒ ì˜¤ë¥˜: ${error.message}`, 'error');
            });
        }

        function updateQueueInfo(data) {
            document.getElementById('lastUpdate').textContent = new Date().toLocaleTimeString();
            
            if (data.total_count !== undefined) {
                document.getElementById('totalCount').textContent = data.total_count;
            }
            if (data.processing_count !== undefined) {
                document.getElementById('processingCount').textContent = data.processing_count;
            }
            if (data.avg_wait_time !== undefined) {
                document.getElementById('avgWaitTime').textContent = data.avg_wait_time + 'ë¶„';
            }
        }

        function clearMessages() {
            messagesDiv.innerHTML = '';
        }

        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }

        async function loadRealQueueId() {
            try {
                const response = await fetch('http://localhost:8000/api/v1/queue/');
                const data = await response.json();
                
                if (data.results && data.results.length > 0) {
                    const realQueueId = data.results[0].queue_id;
                    document.getElementById('queueId').value = realQueueId;
                    addMessage(`âœ… ì‹¤ì œ Queue ID ìë™ ë¡œë“œ: ${realQueueId}`, 'info');
                    return realQueueId;
                } else {
                    addMessage('âŒ ì‹¤ì œ Queue ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.', 'error');
                    return null;
                }
            } catch (error) {
                addMessage(`âŒ Queue ID ë¡œë“œ ì‹¤íŒ¨: ${error.message}`, 'error');
                return null;
            }
        }

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ìë™ìœ¼ë¡œ ì‹¤ì œ Queue ID ë¡œë“œ
        window.addEventListener('load', function() {
            setTimeout(() => {
                loadRealQueueId();
            }, 1000);
        });

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸° ìƒíƒœ
        updateStatus(false);
        addMessage('ğŸ’¡ ì‹¤ì‹œê°„ ëŒ€ê¸°ì—´ í…ŒìŠ¤íŠ¸ í˜ì´ì§€ê°€ ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤. ì—°ê²° ë²„íŠ¼ì„ í´ë¦­í•˜ì„¸ìš”!', 'info');
    </script>
</body>
</html>