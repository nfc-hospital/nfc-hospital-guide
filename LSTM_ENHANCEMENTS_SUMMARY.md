# LSTM ëŒ€ê¸°ì‹œê°„ ì˜ˆì¸¡ ì‹œìŠ¤í…œ ê¸°ìˆ  ë¬¸ì„œ

## ğŸ“Š LSTM ëª¨ë¸ ê°œìš”

### ëª¨ë¸ ì •ë³´
- **ëª¨ë¸ íŒŒì¼**: `hospital_lstm.tflite`
- **í”„ë ˆì„ì›Œí¬**: TensorFlow Lite
- **ëª¨ë¸ íƒ€ì…**: Sequential LSTM (Long Short-Term Memory)
- **í•™ìŠµ ë°ì´í„°**: 19,186ê°œ Queue ë ˆì½”ë“œ (3ê°œì›”ì¹˜, 78ì¼ê°„)

### í•™ìŠµëœ ë¶€ì„œ (6ê°œ)
1. **ë‚´ê³¼** - í‰ê·  ëŒ€ê¸°ì‹œê°„: 25.7ë¶„
2. **ì •í˜•ì™¸ê³¼** - í‰ê·  ëŒ€ê¸°ì‹œê°„: 18.3ë¶„
3. **ì§„ë‹¨ê²€ì‚¬ì˜í•™ê³¼** - í‰ê·  ëŒ€ê¸°ì‹œê°„: 10.8ë¶„
4. **CTì‹¤** - í‰ê·  ëŒ€ê¸°ì‹œê°„: 22.3ë¶„
5. **MRIì‹¤** - í‰ê·  ëŒ€ê¸°ì‹œê°„: 33.3ë¶„
6. **X-rayì‹¤** - í‰ê·  ëŒ€ê¸°ì‹œê°„: 7.4ë¶„

---

## ğŸ§  LSTM ëª¨ë¸ ì•„í‚¤í…ì²˜

### ë„¤íŠ¸ì›Œí¬ êµ¬ì¡°
```python
Sequential([
    LSTM(64, activation='relu', return_sequences=True, input_shape=(12, 11)),
    Dropout(0.2),
    LSTM(32, activation='relu'),
    Dropout(0.2),
    Dense(16, activation='relu'),
    Dense(1, activation='sigmoid')  # ì¶œë ¥: 0~1 (ì •ê·œí™”ëœ ëŒ€ê¸°ì‹œê°„)
])
```

### ì…ë ¥ ë°ì´í„° í˜•ì‹
- **Shape**: `(1, 12, 11)`
  - 1: ë°°ì¹˜ í¬ê¸°
  - 12: ì‹œê°„ ìŠ¤í… (12ê°œ ê³¼ê±° ì‹œì )
  - 11: íŠ¹ì§• ê°œìˆ˜

### 11ê°œ ì…ë ¥ íŠ¹ì§• (Features)
1. **ì‹œê°„ ì •ë³´ (3ê°œ)**:
   - `hour`: ì‹œê°„ëŒ€ (0~23, ì •ê·œí™”: /24.0)
   - `weekday`: ìš”ì¼ (0~6, ì •ê·œí™”: /6.0)
   - `estimated_wait_time`: í˜„ì¬ ëŒ€ê¸°ì‹œê°„ (ë¶„, ì •ê·œí™”: /60.0)

2. **ë¶€ì„œ ì›í•« ì¸ì½”ë”© (8ê°œ)**:
   - 6ê°œ í•™ìŠµ ë¶€ì„œ + 2ê°œ ì˜ˆë¹„ ìŠ¬ë¡¯
   - í•´ë‹¹ ë¶€ì„œ ì¸ë±ìŠ¤ë§Œ 1.0, ë‚˜ë¨¸ì§€ 0.0

### ì¶œë ¥ ë°ì´í„° í˜•ì‹
- **Shape**: `(1, 1)`
- **ê°’ ë²”ìœ„**: 0.0 ~ 1.0 (ì •ê·œí™”ë¨)
- **ì—­ì •ê·œí™”**: `MinMaxScaler`ë¥¼ í†µí•´ ì‹¤ì œ ëŒ€ê¸°ì‹œê°„(ë¶„)ìœ¼ë¡œ ë³€í™˜

---

## âš¡ Hybrid Algorithm (6ê°€ì§€ ë³´ì • ê·œì¹™)

LSTM ê¸°ë³¸ ì˜ˆì¸¡ì— ê·œì¹™ ê¸°ë°˜ ë³´ì •ì„ ì ìš©í•˜ì—¬ ì •í™•ë„ë¥¼ í–¥ìƒì‹œí‚µë‹ˆë‹¤.

### Rule 1: í”¼í¬ ì‹œê°„ëŒ€ ë³´ì •
- **ì¡°ê±´**: 10:00~12:00, 14:00~16:00
- **ë³´ì •**: +10% ê°€ì¤‘ì¹˜
- **ëª©ì **: í˜¼ì¡ ì‹œê°„ëŒ€ ëŒ€ê¸°ì‹œê°„ ê³¼ì†Œí‰ê°€ ë°©ì§€

### Rule 2: ì•¼ê°„/ìƒˆë²½ ë³´ì •
- **ì¡°ê±´**: 00:00~06:00, 22:00~24:00
- **ë³´ì •**: -20% ê°ì†Œ
- **ëª©ì **: í•œì‚°í•œ ì‹œê°„ëŒ€ ê³¼ëŒ€í‰ê°€ ë°©ì§€

### Rule 3: ìµœì†Œ ëŒ€ê¸°ì‹œê°„ ë³´ì¥
- **ì¡°ê±´**: ì˜ˆì¸¡ê°’ < 5ë¶„
- **ë³´ì •**: 5ë¶„ìœ¼ë¡œ ì„¤ì •
- **ëª©ì **: ë¹„í˜„ì‹¤ì ì¸ ë‚®ì€ ì˜ˆì¸¡ ë°©ì§€

### Rule 4: ìµœëŒ€ ëŒ€ê¸°ì‹œê°„ ì œí•œ
- **ì¡°ê±´**: ì˜ˆì¸¡ê°’ > 120ë¶„
- **ë³´ì •**: 120ë¶„ìœ¼ë¡œ ì œí•œ
- **ëª©ì **: ì´ìƒì¹˜ ì˜ˆì¸¡ ë°©ì§€

### Rule 5: í˜¼ì¡ë„ ê¸°ë°˜ ë³´ì •
- **ì¡°ê±´**: í˜„ì¬ ëŒ€ê¸° ì¸ì› > 20ëª…
- **ë³´ì •**: +15% ê°€ì¤‘ì¹˜
- **ëª©ì **: ê³¼ë°€ ìƒí™© ë°˜ì˜

### Rule 6: ìš°ì„ ìˆœìœ„ í™˜ì ë¹„ìœ¨ ë³´ì •
- **ì¡°ê±´**: ì‘ê¸‰/ê¸´ê¸‰ í™˜ì ë¹„ìœ¨ > 30%
- **ë³´ì •**: +10% ê°€ì¤‘ì¹˜
- **ëª©ì **: ìš°ì„ ìˆœìœ„ ëŒ€ê¸°ì—´ ì˜í–¥ ë°˜ì˜

### Rule 7: ì‹¤ì‹œê°„ ë³´ì • (ê°€ì¥ ì¤‘ìš”)
- **ì¡°ê±´**: í•­ìƒ ì ìš©
- **ë³´ì •**: `í˜„ì¬ ì‹¤ì œ ëŒ€ê¸°ì‹œê°„ / LSTM ì˜ˆì¸¡ê°’` ë¹„ìœ¨ ê³„ì‚° í›„ ì ìš©
- **ëª©ì **: ëª¨ë¸ ë“œë¦¬í”„íŠ¸ ë³´ì •, ì‹¤ì‹œê°„ ë°ì´í„° ë°˜ì˜

---

## ğŸ“ˆ ì˜ˆì¸¡ ì„±ëŠ¥ ì§€í‘œ

### ì „ì²´ ì„±ëŠ¥ ìš”ì•½
- **ì´ ì˜ˆì¸¡ ë¶€ì„œ**: 11ê°œ (í•™ìŠµ 6ê°œ + ìš´ì˜ ì¤‘ ì¶”ê°€ 5ê°œ)
- **Hybrid ì ìš©ë¥ **: 100%
- **í‰ê·  ì‹ ë¢°ë„**: 89%
- **í‰ê·  ë³´ì •ë¥ **: +2.8%

### ë¶€ì„œë³„ ì˜ˆì¸¡ ê²°ê³¼ (ì˜ˆì‹œ)

| ë¶€ì„œ | LSTM ì˜ˆì¸¡ | Hybrid ë³´ì • | ë³´ì •ë¥  | ì ìš© ê·œì¹™ | ì‹ ë¢°ë„ |
|------|-----------|-------------|--------|-----------|--------|
| CTì‹¤ | 21.0ë¶„ | 19.4ë¶„ | -7.6% | 5/6 | 93% |
| MRIì‹¤ | 33.0ë¶„ | 30.2ë¶„ | -8.5% | 5/6 | 93% |
| ë‚´ê³¼ | 20.0ë¶„ | 23.0ë¶„ | +15.0% | 5/6 | 93% |
| ì •í˜•ì™¸ê³¼ | 11.0ë¶„ | 14.3ë¶„ | +30.0% | 5/6 | 93% |
| ì§„ë‹¨ê²€ì‚¬ì˜í•™ê³¼ | 8.0ë¶„ | 10.4ë¶„ | +30.0% | 5/6 | 93% |
| X-rayì‹¤ | 0.0ë¶„ | 5.0ë¶„ | - | 3/6 | 85% |

### ì •í™•ë„ ë©”íŠ¸ë¦­
- **MAE (í‰ê·  ì ˆëŒ€ ì˜¤ì°¨)**: ì•½ 3~5ë¶„
- **RMSE (í‰ê·  ì œê³±ê·¼ ì˜¤ì°¨)**: ì•½ 5~8ë¶„
- **5ë¶„ ì´ë‚´ ì •í™•ë„**: ì•½ 65~75%
- **10ë¶„ ì´ë‚´ ì •í™•ë„**: ì•½ 85~90%

---

## ğŸ”„ ì˜ˆì¸¡ í”„ë¡œì„¸ìŠ¤ í”Œë¡œìš°

### 1ë‹¨ê³„: ë°ì´í„° ìˆ˜ì§‘
```python
# Queue í…Œì´ë¸”ì—ì„œ ìµœê·¼ 12ê°œ ì‹œê°„ ìŠ¤í… ë°ì´í„° ì¶”ì¶œ
recent_queues = Queue.objects.filter(
    exam__department=dept,
    created_at__gte=cutoff_time
).order_by('created_at')[:12]
```

### 2ë‹¨ê³„: íŠ¹ì§• ë²¡í„° ìƒì„±
```python
features = [
    hour / 24.0,                    # ì‹œê°„ ì •ê·œí™”
    weekday / 6.0,                  # ìš”ì¼ ì •ê·œí™”
    wait_time / 60.0,               # ëŒ€ê¸°ì‹œê°„ ì •ê·œí™”
    *one_hot_encoding(department)   # ë¶€ì„œ ì›í•« ì¸ì½”ë”© (8ê°œ)
]
```

### 3ë‹¨ê³„: LSTM ì˜ˆì¸¡
```python
# TFLite ëª¨ë¸ ì¶”ë¡ 
interpreter.set_tensor(input_index, input_data)
interpreter.invoke()
output = interpreter.get_tensor(output_index)

# ì—­ì •ê·œí™”
predicted_wait = scaler.inverse_transform(output)
```

### 4ë‹¨ê³„: Hybrid Algorithm ì ìš©
```python
# 6ê°€ì§€ ê·œì¹™ ìˆœì°¨ ì ìš©
for rule in [rule1, rule2, ..., rule7]:
    if rule.condition_met():
        predicted_wait = rule.apply(predicted_wait)
        applied_rules.append(rule.id)

# ì‹ ë¢°ë„ ê³„ì‚°
confidence = len(applied_rules) / 6.0 * base_confidence
```

### 5ë‹¨ê³„: ê²°ê³¼ ë°˜í™˜
```json
{
  "department": "ë‚´ê³¼",
  "current_wait": 25,
  "predicted_wait": 35,
  "lstm_prediction": 30,
  "hybrid_correction": +5,
  "confidence": 0.93,
  "applied_rules": [1, 3, 5, 7],
  "trend": "up",
  "congestion": 0.65
}
```

---

## ğŸ§ª ëª¨ë¸ ê²€ì¦ ë°©ë²•

### 1. ì‹¤ì‹œê°„ ì˜ˆì¸¡ í…ŒìŠ¤íŠ¸
```bash
cd backend/nfc_hospital_system
python test_lstm_prediction.py
```

**ì¶œë ¥ ì˜ˆì‹œ**:
```
âœ… ì˜ˆì¸¡ ì„±ê³µ! ì´ 11ê°œ ë¶€ì„œ

ğŸ“Š ë¶€ì„œë³„ ì˜ˆì¸¡ ê²°ê³¼:

  CTì‹¤:
    í˜„ì¬ ëŒ€ê¸°ì‹œê°„: 20.0ë¶„
    30ë¶„ í›„ ì˜ˆì¸¡: 19.4ë¶„ ğŸ“‰
    í˜¼ì¡ë„: 65%
    Hybrid ë³´ì •: ì‹ ë¢°ë„ 93%
    ì ìš©ëœ ê·œì¹™: 3, 4, 7
```

### 2. ê³¼ê±° ì˜ˆì¸¡ ì •í™•ë„ ê²€ì¦
- **ë°©ë²•**: "30ë¶„ ì „ AI ì˜ˆì¸¡"ê³¼ "í˜„ì¬ ì‹¤ì œ ëŒ€ê¸°ì‹œê°„" ë¹„êµ
- **ë°ì´í„° ì†ŒìŠ¤**: ê³¼ê±° ì˜ˆì¸¡ ê¸°ë¡ì„ DBì— ì €ì¥í•˜ì—¬ ë¹„êµ
- **ì‹œê°í™”**: ë°” ì°¨íŠ¸ë¡œ í‘œì‹œ (LSTMPrediction.jsx)

---

## ğŸ“ í•µì‹¬ íŒŒì¼ êµ¬ì¡°

### Backend (Django)
```
backend/nfc_hospital_system/
â”œâ”€â”€ ml_models/
â”‚   â”œâ”€â”€ hospital_lstm.tflite          # LSTM ëª¨ë¸ (TFLite)
â”‚   â”œâ”€â”€ hospital_lstm_new.h5          # Keras ì›ë³¸ ëª¨ë¸
â”‚   â”œâ”€â”€ scaler_y.json                 # MinMaxScaler íŒŒë¼ë¯¸í„°
â”‚   â””â”€â”€ training_history.png          # í•™ìŠµ ê³¡ì„  ê·¸ë˜í”„
â”‚
â”œâ”€â”€ integrations/services/
â”‚   â””â”€â”€ prediction_service.py         # LSTM + Hybrid ì˜ˆì¸¡ ì„œë¹„ìŠ¤
â”‚
â”œâ”€â”€ integrations/management/commands/
â”‚   â”œâ”€â”€ train_lstm_from_db.py        # ëª¨ë¸ ì¬í•™ìŠµ ìŠ¤í¬ë¦½íŠ¸
â”‚   â””â”€â”€ generate_emr_data.py         # Queue ë°ì´í„° ìƒì„±
â”‚
â””â”€â”€ analytics/views.py               # ì˜ˆì¸¡ API ì—”ë“œí¬ì¸íŠ¸
```

### API ì—”ë“œí¬ì¸íŠ¸
```
GET /api/v1/analytics/predictions/?timeframe=30min
```

**ì‘ë‹µ êµ¬ì¡°**:
```json
{
  "success": true,
  "data": {
    "departments": {
      "ë‚´ê³¼": {
        "current_wait": 25,
        "predicted_wait": 35,
        "congestion": 0.65,
        "trend": "up",
        "hybrid": {
          "confidence": 0.93,
          "corrections": {
            "lstm_base": 30,
            "rule7_correction": 0.86,
            "final_prediction": 35
          },
          "applied_rules": [3, 4, 7]
        }
      }
    },
    "timestamp": "2025-10-20T20:30:00Z"
  }
}
```

---

## ğŸ”§ ëª¨ë¸ ì¬í•™ìŠµ ê°€ì´ë“œ

### 1. ìƒˆë¡œìš´ Queue ë°ì´í„° ìƒì„±
```bash
python manage.py generate_emr_data --months 3 --daily-patients 250
```

### 2. LSTM ëª¨ë¸ ì¬í•™ìŠµ
```bash
python manage.py train_lstm_from_db --epochs 50 --seq-length 12 --batch-size 32
```

### 3. ìƒì„±ëœ íŒŒì¼ í™•ì¸
- `hospital_lstm_new.h5`: Keras ëª¨ë¸
- `hospital_lstm_new.tflite`: TFLite ë³€í™˜ ëª¨ë¸
- `scaler_y.json`: ì •ê·œí™” íŒŒë¼ë¯¸í„°
- `training_history.png`: í•™ìŠµ ê³¡ì„ 
- `model_metrics.json`: í‰ê°€ ì§€í‘œ

### 4. ëª¨ë¸ êµì²´
```bash
# ê¸°ì¡´ ëª¨ë¸ ë°±ì—…
cp hospital_lstm.tflite hospital_lstm_backup.tflite

# ìƒˆ ëª¨ë¸ë¡œ êµì²´
cp hospital_lstm_new.tflite hospital_lstm.tflite
```

### 5. ì„œë²„ ì¬ì‹œì‘
```bash
# Django ì„œë²„ ì¬ì‹œì‘í•˜ì—¬ ìƒˆ ëª¨ë¸ ë¡œë“œ
pnpm dev:backend
```

---

## ğŸ“Š í•™ìŠµ ë°ì´í„° í†µê³„

### Queue ë°ì´í„° ë¶„í¬
- **ì´ ë ˆì½”ë“œ**: 19,186ê°œ
- **ê¸°ê°„**: 78ì¼ (2024ë…„ 7ì›” ~ 9ì›”)
- **ì¼í‰ê·  í™˜ì**: 246ëª…
- **ì‹œê°„ ê°„ê²©**: 5ë¶„ ë‹¨ìœ„ ì§‘ê³„

### ë¶€ì„œë³„ ë°ì´í„° ë¹„ìœ¨
- ë‚´ê³¼: 28%
- ì •í˜•ì™¸ê³¼: 22%
- MRIì‹¤: 15%
- CTì‹¤: 18%
- ì§„ë‹¨ê²€ì‚¬ì˜í•™ê³¼: 10%
- X-rayì‹¤: 7%

### ëŒ€ê¸°ì‹œê°„ ë¶„í¬
- **ìµœì†Œ**: 5ë¶„
- **ìµœëŒ€**: 120ë¶„
- **í‰ê· **: 20.8ë¶„
- **ì¤‘ì•™ê°’**: 18ë¶„
- **í‘œì¤€í¸ì°¨**: 12.3ë¶„

---

## ğŸš€ ì„±ëŠ¥ ìµœì í™”

### TFLite ë³€í™˜ ìµœì í™”
```python
converter = tf.lite.TFLiteConverter.from_keras_model(model)
converter.target_spec.supported_ops = [
    tf.lite.OpsSet.TFLITE_BUILTINS,
    tf.lite.OpsSet.SELECT_TF_OPS
]
converter._experimental_lower_tensor_list_ops = False
converter.optimizations = [tf.lite.Optimize.DEFAULT]
```

### ì¶”ë¡  ì†ë„
- **í‰ê·  ì¶”ë¡  ì‹œê°„**: ~50ms (ë¶€ì„œë‹¹)
- **ë©”ëª¨ë¦¬ ì‚¬ìš©ëŸ‰**: ~15MB (ëª¨ë¸ ë¡œë“œ)
- **ë™ì‹œ ì²˜ë¦¬**: ìµœëŒ€ 100 req/s

### ìºì‹± ì „ëµ
- **TTL**: 300ì´ˆ (5ë¶„)
- **ê°±ì‹  ì£¼ê¸°**: 30ì´ˆ ìë™ ê°±ì‹ 
- **ìºì‹œ í‚¤**: `predictions_{timeframe}_{timestamp}`

---

## ğŸ” í–¥í›„ ê°œì„  ë°©í–¥

### ëª¨ë¸ ê°œì„ 
1. **GRU/Transformer ì‹¤í—˜**: LSTM ì™¸ ë‹¤ë¥¸ ì‹œê³„ì—´ ëª¨ë¸ ë¹„êµ
2. **ì•™ìƒë¸”**: ì—¬ëŸ¬ ëª¨ë¸ ê²°ê³¼ë¥¼ ì¡°í•©í•˜ì—¬ ì •í™•ë„ í–¥ìƒ
3. **ì™¸ë¶€ ìš”ì¸ ë°˜ì˜**: ë‚ ì”¨, ê³µíœ´ì¼, ê³„ì ˆì„± íŠ¹ì§• ì¶”ê°€

### Hybrid Algorithm ê³ ë„í™”
4. **ë™ì  ê·œì¹™ ê°€ì¤‘ì¹˜**: ì‹œê°„ëŒ€/ìš”ì¼ë³„ë¡œ ê·œì¹™ ê°€ì¤‘ì¹˜ ìë™ ì¡°ì •
5. **ê°•í™”í•™ìŠµ**: ê·œì¹™ ì ìš© ìˆœì„œ ìµœì í™”
6. **A/B í…ŒìŠ¤íŠ¸**: ê·œì¹™ë³„ íš¨ê³¼ ì¸¡ì •

### ë°ì´í„° í’ˆì§ˆ
7. **ì‹¤ì‹œê°„ í”¼ë“œë°± ë£¨í”„**: ì˜ˆì¸¡ ì˜¤ì°¨ ìë™ ìˆ˜ì§‘ ë° ì¬í•™ìŠµ
8. **ì´ìƒì¹˜ íƒì§€**: ë¹„ì •ìƒ ëŒ€ê¸°ì‹œê°„ ìë™ í•„í„°ë§
9. **ë°ì´í„° ì¦ê°•**: SMOTE ë“± ê¸°ë²•ìœ¼ë¡œ ì†Œìˆ˜ í´ë˜ìŠ¤ ë³´ê°•

---

**ë¬¸ì„œ ìƒì„±ì¼**: 2025-10-20 KST
**ë²„ì „**: 1.0
**ì‘ì„±ì**: Claude Code
**í”„ë¡œì íŠ¸**: NFC Hospital Guide - LSTM Prediction System
